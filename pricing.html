async function loadSheetsList() {
  console.log('✅ loadSheetsList 函數被呼叫');
  
  const sheetsUrl = document.getElementById('sheetsId').value;
  
  if (!sheetsUrl) {
    alert('⚠️ 請先輸入 Google Sheets 完整網址！\n\n範例：https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit');
    return;
  }
  
  // 從網址提取 Sheets ID
  const match = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if (!match) {
    alert('⚠️ 網址格式不正確！\n\n請確認您複製了完整的 Google Sheets 網址');
    return;
  }
  
  const sheetsId = match[1];
  console.log('✅ Sheets ID:', sheetsId);
  
  // 保存網址
  localStorage.setItem('sheetsUrl', sheetsUrl);
  localStorage.setItem('sheetsId', sheetsId);
  
  // 顯示載入中
  document.getElementById('connectionResult').innerHTML = `
    <div class="ai-suggestion" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <p style="color: white; margin: 0;">⏳ 正在解析試算表...</p>
    </div>
  `;
  
  // 提示用戶手動輸入工作表名稱
  promptForSheetNames(sheetsId);
}

function promptForSheetNames(sheetsId) {
  document.getElementById('connectionResult').innerHTML = `
    <div class="cost-card" style="margin-top: 20px;">
      <h3 style="color: #2563eb; margin-bottom: 15px;">📝 請輸入您的工作表名稱</h3>
      
      <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <p style="margin: 0 0 10px 0; color: #92400e; font-weight: 600;">💡 如何找到工作表名稱？</p>
        <ol style="margin: 0; padding-left: 20px; color: #78350f;">
          <li>打開您的 Google Sheets</li>
          <li>看<strong>左下角</strong>的標籤名稱</li>
          <li>逐個輸入到下方欄位中</li>
        </ol>
      </div>
      
      <div id="sheetNameInputs">
        <div class="input-group" style="margin-bottom: 10px;">
          <label>工作表 1：</label>
          <input type="text" id="sheetName1" placeholder="例如：智同_產品庫" 
                 style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
        <div class="input-group" style="margin-bottom: 10px;">
          <label>工作表 2：</label>
          <input type="text" id="sheetName2" placeholder="例如：旭煌_產品庫" 
                 style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn" onclick="addMoreSheetInput()" 
                style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
          ➕ 新增更多工作表
        </button>
        <button class="btn" onclick="saveAndLoadSheets()" 
                style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
          💾 保存並載入工作表
        </button>
      </div>
    </div>
  `;
}

let sheetInputCount = 2;

function addMoreSheetInput() {
  sheetInputCount++;
  const container = document.getElementById('sheetNameInputs');
  const newInput = document.createElement('div');
  newInput.className = 'input-group';
  newInput.style = 'margin-bottom: 10px;';
  newInput.innerHTML = `
    <label>工作表 ${sheetInputCount}：</label>
    <input type="text" id="sheetName${sheetInputCount}" placeholder="輸入工作表名稱" 
           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
  `;
  container.appendChild(newInput);
}

async function saveAndLoadSheets() {
  const sheetsId = localStorage.getItem('sheetsId');
  const sheetNames = [];
  
  // 收集所有輸入的工作表名稱
  for (let i = 1; i <= sheetInputCount; i++) {
    const input = document.getElementById(`sheetName${i}`);
    if (input && input.value.trim()) {
      sheetNames.push(input.value.trim());
    }
  }
  
  if (sheetNames.length === 0) {
    alert('⚠️ 請至少輸入一個工作表名稱！');
    return;
  }
  
  console.log('✅ 保存的工作表名稱:', sheetNames);
  
  // 保存工作表名稱
  localStorage.setItem('userSheetNames', JSON.stringify(sheetNames));
  
  // 顯示載入中
  document.getElementById('connectionResult').innerHTML = `
    <div class="ai-suggestion" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <p style="color: white; margin: 0;">⏳ 正在讀取 ${sheetNames.length} 個工作表的數據...</p>
    </div>
  `;
  
  // 嘗試讀取每個工作表的數據
  availableSheets = [];
  
  for (const sheetName of sheetNames) {
    try {
      const data = await fetchSheetData(sheetsId, sheetName);
      availableSheets.push({
        name: sheetName,
        type: 'product',
        count: data.length,
        desc: `包含 ${data.length} 筆資料`,
        data: data
      });
      console.log(`✅ ${sheetName}: ${data.length} 筆資料`);
    } catch (error) {
      console.error(`❌ 無法讀取 ${sheetName}:`, error);
      availableSheets.push({
        name: sheetName,
        type: 'product',
        count: 0,
        desc: '讀取失敗',
        data: []
      });
    }
  }
  
  displaySheetsList();
  
  console.log('✅ 工作表清單已顯示，共', availableSheets.length, '個工作表');
}

async function fetchSheetData(sheetsId, sheetName) {
  // 方法 1: 嘗試使用公開的 CSV 導出（需要知道 gid）
  // 方法 2: 使用 Google Sheets 發布為網頁功能
  // 方法 3: 目前先使用模擬數據，等用戶確認後再實作真實讀取
  
  console.log(`📥 嘗試讀取工作表: ${sheetName}`);
  
  // 暫時返回模擬數據（下一步會實作真實讀取）
  return new Promise((resolve) => {
    setTimeout(() => {
      // 模擬一些產品數據
      const mockData = [
        { 商品名稱: '商品A', 進貨單價: 100, 規格: 'L', 顏色: '黑色' },
        { 商品名稱: '商品B', 進貨單價: 150, 規格: 'M', 顏色: '白色' }
      ];
      resolve(mockData);
    }, 500);
  });
}
