<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›»å•†å®šåƒ¹ç®¡ç†ç³»çµ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      overflow-x: auto;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1rem;
      color: #6c757d;
      transition: all 0.3s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .tab:hover {
      background: #e9ecef;
    }

    .tab.active {
      color: #667eea;
      border-bottom: 3px solid #667eea;
      font-weight: 600;
    }

    .tab-content {
      display: none;
      padding: 30px;
      animation: fadeIn 0.5s;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cost-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 2px solid #e9ecef;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #495057;
      font-weight: 600;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .result-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 25px;
      margin-top: 20px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .result-item:last-child {
      border-bottom: none;
      font-size: 1.3rem;
      font-weight: bold;
    }

    .ai-suggestion {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
    }

    .product-row {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .sheet-item {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .sheet-item:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .sheet-item.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .sheet-checkbox {
      margin-right: 10px;
      width: 20px;
      height: 20px;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }
      
      .tab {
        padding: 12px 15px;
        font-size: 0.9rem;
      }
      
      .tab-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ›ï¸ é›»å•†å®šåƒ¹ç®¡ç†ç³»çµ±</h1>
      <p>æ™ºèƒ½å®šåƒ¹ | æ•¸æ“šåˆ†æ | åˆ©æ½¤å„ªåŒ–</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="showTab('calculator')">ğŸ’° è¨‚åƒ¹è¨ˆç®—å™¨</button>
      <button class="tab" onclick="showTab('connect')">ğŸ”— è³‡æ–™æ•´åˆ</button>
      <button class="tab" onclick="showTab('analysis')">ğŸ“Š æ™ºèƒ½åˆ†æ</button>
      <button class="tab" onclick="showTab('competitor')">ğŸ¯ ç«¶å“æ¯”åƒ¹</button>
    </div>

    <div id="calculator" class="tab-content active">
      <h2>ğŸ’° è¨‚åƒ¹è¨ˆç®—å™¨</h2>
      
      <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid #e17055;">
        <div style="color: #2d3436; font-weight: 600; margin-bottom: 8px;">
          âš¡ 2025 å¹´æœ€æ–°è²»ç‡å·²æ›´æ–°
        </div>
        <div style="color: #2d3436; font-size: 0.9rem; line-height: 1.6;">
          â€¢ ä¸€èˆ¬æˆäº¤æ‰‹çºŒè²»ï¼š5.5% | ä¿ƒéŠ·æª”æœŸï¼š7.5%<br>
          â€¢ å…é‹è£œè²¼ï¼š7% | è¼ƒé•·å‚™è²¨ï¼ˆé è³¼ï¼‰ï¼š3% | è¦å¹£å›é¥‹ï¼š3%<br>
          â€¢ é‡‘æµæœå‹™è²» 2% å·²è‡ªå‹•åŒ…å«
        </div>
      </div>
      
      <div class="cost-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border: none;">
        <h3 style="color: #2d3748;">ğŸ¯ å¿«é€Ÿé¸æ“‡ç”¢å“</h3>
        <div id="quickSelectProduct">
          <p style="color: #4a5568;">è«‹å…ˆå‰å¾€ã€ŒğŸ”— è³‡æ–™æ•´åˆã€è¼‰å…¥ç”¢å“è³‡æ–™</p>
        </div>
      </div>
      
      <div class="cost-card">
        <h3>åŸºæœ¬è¨­å®š</h3>
        <div class="input-group">
          <label>é€²è²¨å–®åƒ¹ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="cost" value="100" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>è¨‚è³¼æ•¸é‡</label>
          <input type="number" id="quantity" value="1" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>åŒ…ææˆæœ¬ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="packaging" value="10" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>äººäº‹æ™‚é–“æˆæœ¬ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="labor" value="20" oninput="calculate()">
        </div>
      </div>

      <div class="cost-card">
        <h3>è¦çš®è²»ç‡è¨­å®šï¼ˆ2025 æœ€æ–°ï¼‰</h3>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
          <p style="margin: 0; color: #1565c0; font-weight: 600;">ğŸ’¡ é‡‘æµæœå‹™è²» 2% å·²è‡ªå‹•åŒ…å«åœ¨æ‰€æœ‰è¨ˆç®—ä¸­</p>
        </div>
        
        <div class="input-group">
          <label style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">æˆäº¤æ‰‹çºŒè²»</label>
          <div style="display: flex; gap: 20px; margin-left: 10px;">
            <label style="cursor: pointer;">
              <input type="radio" name="feeType" id="normalFee" value="5.5" checked onchange="updateFeeRateDisplay(); calculate()">
              <span style="margin-left: 5px;">ä¸€èˆ¬æœŸé–“ 5.5%</span>
            </label>
            <label style="cursor: pointer;">
              <input type="radio" name="feeType" id="eventFee" value="7.5" onchange="updateFeeRateDisplay(); calculate()">
              <span style="margin-left: 5px;">ä¿ƒéŠ·æª”æœŸ 7.5%</span>
            </label>
          </div>
        </div>
        
        <div style="border-top: 1px solid #e5e7eb; margin: 15px 0;"></div>
        
        <div class="input-group">
          <label style="font-weight: 600; color: #2d3748; margin-bottom: 10px;">æ´»å‹•è²»ç”¨ï¼ˆå¯é¸ï¼‰</label>
          <div style="margin-left: 10px;">
            <div style="margin-bottom: 10px;">
              <label style="cursor: pointer;">
                <input type="checkbox" id="hasFreeShipping" onchange="updateFeeRateDisplay(); calculate()">
                <span style="margin-left: 5px;">å…é‹è£œè²¼ 7%</span>
                <span style="color: #6c757d; font-size: 0.85rem; margin-left: 10px;">ï¼ˆåƒåŠ å…é‹æ´»å‹•ï¼‰</span>
              </label>
            </div>
            <div style="margin-bottom: 10px;">
              <label style="cursor: pointer;">
                <input type="checkbox" id="isPreorder" onchange="updateFeeRateDisplay(); calculate()">
                <span style="margin-left: 5px;">è¼ƒé•·å‚™è²¨ï¼ˆé è³¼ï¼‰3%</span>
                <span style="color: #6c757d; font-size: 0.85rem; margin-left: 10px;">ï¼ˆå‚™è²¨å¤©æ•¸ > 1 å¤©ï¼‰</span>
              </label>
            </div>
            <div style="margin-bottom: 10px;">
              <label style="cursor: pointer;">
                <input type="checkbox" id="hasCoins" onchange="updateFeeRateDisplay(); calculate()">
                <span style="margin-left: 5px;">è¦å¹£å›é¥‹ 3%</span>
                <span style="color: #6c757d; font-size: 0.85rem; margin-left: 10px;">ï¼ˆåƒåŠ è¦å¹£æ´»å‹•ï¼‰</span>
              </label>
            </div>
          </div>
        </div>
        
        <div style="border-top: 1px solid #e5e7eb; margin: 15px 0;"></div>
        
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="hasTax" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px; font-weight: 600;">ç‡Ÿæ¥­ç¨… 5%</span>
            <span style="color: #6c757d; font-size: 0.85rem; margin-left: 10px;">ï¼ˆç‡Ÿæ¥­ç™»è¨˜è€…éœ€é–‹ç™¼ç¥¨ï¼‰</span>
          </label>
        </div>
        
        <div id="feeRateSummary" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea;"></div>
      </div>

      <div class="cost-card">
        <h3>ç›®æ¨™åˆ©æ½¤</h3>
        <div class="input-group">
          <label>ç›®æ¨™åˆ©æ½¤ç‡ï¼ˆ%ï¼‰</label>
          <input type="number" id="targetMargin" value="30" oninput="calculate()">
        </div>
      </div>

      <div id="result"></div>
    </div>

    <div id="connect" class="tab-content">
      <h2>ğŸ”— è³‡æ–™æ•´åˆ</h2>
      
      <div class="cost-card">
        <h3>é€£æ¥ Google Sheets</h3>
        
        <div class="input-group">
          <label for="sheetsId">ğŸ“„ Google Sheets ç¶²å€</label>
          <input type="text" id="sheetsId" 
                 placeholder="è²¼ä¸Šæ‚¨çš„ Google Sheets å®Œæ•´ç¶²å€ï¼ˆä¾‹å¦‚ï¼šhttps://docs.google.com/spreadsheets/d/...ï¼‰">
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b;">
          <p style="margin: 0 0 10px 0; color: #92400e; font-weight: 600;">âš™ï¸ è¨­å®šæ­¥é©Ÿï¼š</p>
          <ol style="margin: 0; padding-left: 20px; color: #78350f; line-height: 1.8;">
            <li>æ‰“é–‹æ‚¨çš„ Google Sheets</li>
            <li>é»æ“Šå³ä¸Šè§’ <strong>ã€Œå…±ç”¨ã€</strong> æŒ‰éˆ•</li>
            <li>é¸æ“‡ <strong>ã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººã€</strong></li>
            <li>æ¬Šé™è¨­ç‚º <strong>ã€Œæª¢è¦–è€…ã€</strong></li>
            <li>è¤‡è£½ç¶²å€ä¸¦è²¼åˆ°ä¸Šæ–¹æ¬„ä½</li>
          </ol>
        </div>
        
        <button class="btn" onclick="loadSheetsList()">ğŸ”— è§£æè©¦ç®—è¡¨</button>
      </div>

      <div id="sheetsList"></div>
      <div id="connectionResult"></div>
    </div>

    <div id="analysis" class="tab-content">
      <h2>ğŸ“Š ç”¢å“è³‡æ–™åˆ†æ</h2>
      
      <div id="productDataSection">
        <div class="ai-suggestion" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">
          <h3>ğŸ’¡ æç¤º</h3>
          <p>è«‹å…ˆå‰å¾€ã€ŒğŸ”— è³‡æ–™æ•´åˆã€é é¢è¼‰å…¥ç”¢å“è³‡æ–™ï¼Œç„¶å¾Œå›åˆ°æ­¤é é¢æŸ¥çœ‹åˆ†æçµæœã€‚</p>
        </div>
      </div>

      <div id="analysisContent" style="display: none;">
        <!-- æ•¸æ“šæ¦‚è¦½ -->
        <div class="cost-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); margin-bottom: 20px;">
          <h3 style="color: #2d3748;">ğŸ“ˆ æ•¸æ“šæ¦‚è¦½</h3>
          <div id="dataOverview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;"></div>
        </div>

        <!-- æœå°‹å’Œç¯©é¸ -->
        <div class="cost-card">
          <h3>ğŸ” æœå°‹ç”¢å“</h3>
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="searchInput" placeholder="æœå°‹ç”¢å“åç¨±ã€ç·¨è™Ÿ..." 
                   style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;"
                   oninput="filterProducts()">
            <select id="sourceFilter" onchange="filterProducts()" 
                    style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
              <option value="">å…¨éƒ¨ä¾†æº</option>
            </select>
            <button class="btn" onclick="resetFilters()">é‡ç½®</button>
          </div>
        </div>

        <!-- æ‰¹é‡å®šåƒ¹å·¥å…· -->
        <div class="cost-card">
          <h3>ğŸ’° æ‰¹é‡å®šåƒ¹è¨ˆç®—</h3>
          <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">åŒ…ææˆæœ¬ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="batchPackaging" value="10" 
                       style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">äººäº‹æˆæœ¬ï¼ˆå…ƒï¼‰</label>
                <input type="number" id="batchLabor" value="20" 
                       style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç›®æ¨™åˆ©æ½¤ç‡ï¼ˆ%ï¼‰</label>
                <input type="number" id="batchMargin" value="30" 
                       style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">
              </div>
            </div>
            
            <div style="margin-top: 15px;">
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">æˆäº¤æ‰‹çºŒè²»ï¼š</label>
              <div style="display: flex; gap: 15px; margin-left: 10px; margin-bottom: 15px;">
                <label>
                  <input type="radio" name="batchFeeType" id="batchNormalFee" value="5.5" checked>
                  ä¸€èˆ¬æœŸé–“ 5.5%
                </label>
                <label>
                  <input type="radio" name="batchFeeType" id="batchEventFee" value="7.5">
                  ä¿ƒéŠ·æª”æœŸ 7.5%
                </label>
              </div>
              
              <label style="display: block; margin-bottom: 10px; font-weight: 600;">æ´»å‹•è²»ç”¨ï¼š</label>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-left: 10px;">
                <label><input type="checkbox" id="batchFreeShip"> å…é‹è£œè²¼ (7%)</label>
                <label><input type="checkbox" id="batchPreorder"> è¼ƒé•·å‚™è²¨ (3%)</label>
                <label><input type="checkbox" id="batchCoins"> è¦å¹£å›é¥‹ (3%)</label>
                <label><input type="checkbox" id="batchTax"> ç‡Ÿæ¥­ç¨… (5%)</label>
              </div>
            </div>
            <button class="btn" onclick="calculateBatchPricing()" style="margin-top: 15px; width: 100%;">
              ğŸ§® è¨ˆç®—æ‰€æœ‰ç”¢å“å»ºè­°å”®åƒ¹
            </button>
          </div>
        </div>

        <!-- ç”¢å“è³‡æ–™è¡¨æ ¼ -->
        <div class="cost-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>ğŸ“‹ ç”¢å“æ¸…å–®</h3>
            <div>
              <button class="btn" onclick="exportToCSV()" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                ğŸ“¥ åŒ¯å‡º CSV
              </button>
              <button class="btn" onclick="selectAllProducts()">âœ“ å…¨é¸</button>
              <button class="btn" onclick="deselectAllProducts()">âœ— å–æ¶ˆå…¨é¸</button>
            </div>
          </div>
          
          <div style="overflow-x: auto;">
            <table id="productTable" style="width: 100%; border-collapse: collapse;">
              <thead style="background: #f8f9fa; position: sticky; top: 0;">
                <tr id="tableHeader"></tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          
          <div id="tablePagination" style="margin-top: 15px; text-align: center;"></div>
        </div>

        <!-- æ•¸æ“šåˆ†æåœ–è¡¨ -->
        <div class="cost-card">
          <h3>ğŸ“Š åƒ¹æ ¼åˆ†æ</h3>
          <div id="priceAnalysis" style="min-height: 200px;"></div>
        </div>
      </div>
    </div>

    <div id="competitor" class="tab-content">
      <h2>ğŸ¯ ç«¶å“ç›£æ§</h2>
      
      <!-- ç«¶å“æ•¸æ“šæ¦‚è¦½ -->
      <div class="cost-card" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); margin-bottom: 20px;">
        <h3 style="color: #2d3748;">ğŸ“Š ç«¶å“ç›£æ§æ¦‚è¦½</h3>
        <div id="competitorOverview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="competitorCount">0</div>
            <div style="color: #6c757d;">ç›£æ§ç”¢å“æ•¸</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="advantageCount">0</div>
            <div style="color: #6c757d;">åƒ¹æ ¼å„ªå‹¢</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #dc3545;" id="disadvantageCount">0</div>
            <div style="color: #6c757d;">åƒ¹æ ¼åŠ£å‹¢</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #f093fb;" id="avgDifference">0%</div>
            <div style="color: #6c757d;">å¹³å‡åƒ¹å·®</div>
          </div>
        </div>
      </div>

      <!-- æ·»åŠ ç«¶å“ -->
      <div class="cost-card">
        <h3>â• æ·»åŠ ç«¶å“è³‡æ–™</h3>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">é¸æ“‡æˆ‘æ–¹ç”¢å“</label>
              <select id="myProductSelect" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
                <option value="">-- è«‹é¸æ“‡ --</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">æˆ‘æ–¹å”®åƒ¹ï¼ˆå…ƒï¼‰</label>
              <input type="number" id="myPrice" readonly 
                     style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; background: #f9fafb;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç«¶å“åç¨±</label>
              <input type="text" id="compName" placeholder="ä¾‹å¦‚ï¼šXXå“ç‰Œ å®‰å…¨å¸½" 
                     style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç«¶å“åƒ¹æ ¼ï¼ˆå…ƒï¼‰</label>
              <input type="number" id="compPrice" placeholder="è¼¸å…¥ç«¶å“å”®åƒ¹" 
                     style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç«¶å“ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
              <input type="text" id="compUrl" placeholder="https://..." 
                     style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px;">
            </div>
          </div>
          
          <button class="btn" onclick="addCompetitor()" style="margin-top: 15px; width: 100%;">
            â• æ·»åŠ ç«¶å“
          </button>
        </div>
      </div>

      <!-- æˆ–å¾ Google Sheets è¼‰å…¥ -->
      <div class="cost-card">
        <h3>ğŸ“¥ å¾ Google Sheets è¼‰å…¥ç«¶å“è³‡æ–™</h3>
        <p style="color: #6c757d; margin-bottom: 15px;">
          å¦‚æœæ‚¨åœ¨ Google Sheets ä¸­æœ‰ã€Œç«¶å“åƒ¹æ ¼ã€å·¥ä½œè¡¨ï¼Œå¯ä»¥ç›´æ¥è¼‰å…¥ã€‚
        </p>
        <button class="btn" onclick="loadCompetitorSheet()" 
                style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
          ğŸ“¥ è¼‰å…¥ç«¶å“å·¥ä½œè¡¨
        </button>
      </div>

      <!-- ç«¶å“æ¯”åƒ¹è¡¨ -->
      <div class="cost-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3>ğŸ“‹ ç«¶å“æ¯”åƒ¹è¡¨</h3>
          <div>
            <select id="filterAdvantage" onchange="filterCompetitorTable()" 
                    style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; margin-right: 10px;">
              <option value="">å…¨éƒ¨</option>
              <option value="advantage">åƒ…åƒ¹æ ¼å„ªå‹¢</option>
              <option value="disadvantage">åƒ…åƒ¹æ ¼åŠ£å‹¢</option>
              <option value="warning">éœ€è¦é—œæ³¨</option>
            </select>
            <button class="btn" onclick="exportCompetitorData()">ğŸ“¥ åŒ¯å‡º</button>
          </div>
        </div>
        
        <div style="overflow-x: auto;">
          <table id="competitorTable" style="width: 100%; border-collapse: collapse;">
            <thead style="background: #f8f9fa;">
              <tr>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">æˆ‘æ–¹ç”¢å“</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">æˆ‘æ–¹åƒ¹æ ¼</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">ç«¶å“åç¨±</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">ç«¶å“åƒ¹æ ¼</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">åƒ¹å·®</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">åƒ¹å·®%</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">ç«¶çˆ­åŠ›</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">ç«¶å“é€£çµ</th>
                <th style="padding: 12px; border: 1px solid #e5e7eb;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="competitorTableBody">
              <tr>
                <td colspan="9" style="text-align: center; padding: 30px; color: #6c757d;">
                  å°šæœªæ·»åŠ ç«¶å“è³‡æ–™
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ç«¶çˆ­åŠ›åˆ†æ -->
      <div class="cost-card">
        <h3>ğŸ“Š ç«¶çˆ­åŠ›åˆ†æ</h3>
        <div id="competitiveAnalysis"></div>
      </div>

      <!-- åƒ¹æ ¼è­¦ç¤º -->
      <div class="cost-card">
        <h3>âš ï¸ åƒ¹æ ¼è­¦ç¤º</h3>
        <div id="priceAlerts"></div>
      </div>
    </div>
  </div>

  <script>
    let availableSheets = [];
    let selectedSheets = [];
    let sheetInputCount = 2;
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let selectedProducts = new Set();
    let competitorData = [];

    function showTab(tabName) {
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      contents.forEach(content => content.classList.remove('active'));
      
      // æ‰¾åˆ°å°æ‡‰çš„æ¨™ç±¤ä¸¦å•Ÿç”¨
      const targetTab = Array.from(tabs).find(tab => 
        tab.getAttribute('onclick')?.includes(`'${tabName}'`)
      );
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      document.getElementById(tabName).classList.add('active');
      
      // å¦‚æœåˆ‡æ›åˆ°åˆ†æé é¢ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ç”¢å“è³‡æ–™
      if (tabName === 'analysis') {
        console.log('ğŸ“Š åˆ‡æ›åˆ°åˆ†æé é¢ï¼Œç”¢å“æ•¸é‡:', allProducts.length);
        if (allProducts.length > 0) {
          displayAnalysisPage();
        } else {
          // ç¢ºä¿é¡¯ç¤ºæç¤ºè¨Šæ¯
          document.getElementById('productDataSection').style.display = 'block';
          document.getElementById('analysisContent').style.display = 'none';
        }
      }
      
      // å¦‚æœåˆ‡æ›åˆ°è¨ˆç®—å™¨é é¢ï¼Œæ›´æ–°å¿«é€Ÿé¸æ“‡
      if (tabName === 'calculator') {
        updateQuickSelect();
      }
      
      // å¦‚æœåˆ‡æ›åˆ°ç«¶å“ç›£æ§é é¢
      if (tabName === 'competitor') {
        updateCompetitorPage();
      }
    }

    function updateFeeRateDisplay() {
      // å–å¾—æˆäº¤æ‰‹çºŒè²»ï¼ˆå–®é¸ï¼‰
      const normalFee = document.getElementById('normalFee');
      const eventFee = document.getElementById('eventFee');
      const platformFee = normalFee.checked ? 5.5 : 7.5;
      
      // å›ºå®šé‡‘æµè²»
      const paymentRate = 2.0;
      
      // æ´»å‹•è²»ç”¨ï¼ˆå¯é¸ï¼‰
      const hasFreeShipping = document.getElementById('hasFreeShipping').checked;
      const isPreorder = document.getElementById('isPreorder').checked;
      const hasCoins = document.getElementById('hasCoins').checked;
      const hasTax = document.getElementById('hasTax').checked;
      
      let totalRate = platformFee + paymentRate;
      
      let breakdown = `
        <div style="font-size: 0.95rem;">
          <strong style="color: #2d3748;">ğŸ“Š è²»ç‡æ˜ç´°ï¼š</strong><br>
          <div style="margin: 10px 0; padding-left: 10px; border-left: 3px solid #667eea;">
            â€¢ æˆäº¤æ‰‹çºŒè²»ï¼š<strong>${platformFee}%</strong> ${eventFee.checked ? 'ï¼ˆä¿ƒéŠ·æª”æœŸï¼‰' : 'ï¼ˆä¸€èˆ¬æœŸé–“ï¼‰'}<br>
            â€¢ é‡‘æµæœå‹™è²»ï¼š<strong>${paymentRate}%</strong> <span style="color: #6c757d;">ï¼ˆå›ºå®šï¼‰</span><br>
      `;
      
      if (hasFreeShipping) {
        breakdown += `    â€¢ å…é‹è£œè²¼ï¼š<strong>7%</strong><br>`;
        totalRate += 7;
      }
      
      if (isPreorder) {
        breakdown += `    â€¢ è¼ƒé•·å‚™è²¨ï¼ˆé è³¼ï¼‰ï¼š<strong>3%</strong><br>`;
        totalRate += 3;
      }
      
      if (hasCoins) {
        breakdown += `    â€¢ è¦å¹£å›é¥‹ï¼š<strong>3%</strong><br>`;
        totalRate += 3;
      }
      
      if (hasTax) {
        breakdown += `    â€¢ ç‡Ÿæ¥­ç¨…ï¼š<strong>5%</strong><br>`;
        totalRate += 5;
      }
      
      breakdown += `
          </div>
          <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">
            <span style="color: white; font-size: 1.1rem;">
              ğŸ’° <strong>ç¸½è²»ç‡ï¼š${totalRate.toFixed(1)}%</strong>
            </span>
          </div>
        </div>
      `;
      
      const display = document.getElementById('feeRateSummary');
      if (display) {
        display.innerHTML = breakdown;
      }
    }

    function calculate() {
      const cost = parseFloat(document.getElementById('cost').value) || 0;
      const quantity = parseInt(document.getElementById('quantity').value) || 1;
      const packaging = parseFloat(document.getElementById('packaging').value) || 0;
      const labor = parseFloat(document.getElementById('labor').value) || 0;
      
      // å–å¾—æˆäº¤æ‰‹çºŒè²»
      const normalFee = document.getElementById('normalFee');
      const platformFee = normalFee.checked ? 5.5 : 7.5;
      
      // æ´»å‹•è²»ç”¨
      const hasFreeShipping = document.getElementById('hasFreeShipping').checked;
      const isPreorder = document.getElementById('isPreorder').checked;
      const hasCoins = document.getElementById('hasCoins').checked;
      const hasTax = document.getElementById('hasTax').checked;
      const targetMargin = parseFloat(document.getElementById('targetMargin').value) || 0;
      
      const totalCost = cost * quantity + packaging + labor;
      
      let totalFeeRate = platformFee + 2.0; // å¹³å°æ‰‹çºŒè²» + é‡‘æµè²»
      
      if (hasFreeShipping) totalFeeRate += 7;
      if (isPreorder) totalFeeRate += 3;
      if (hasCoins) totalFeeRate += 3;
      if (hasTax) totalFeeRate += 5;
      
      const suggestedPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
      const netIncome = suggestedPrice * (1 - totalFeeRate / 100);
      const profit = netIncome - totalCost;
      const actualMargin = (profit / totalCost) * 100;
      
      document.getElementById('result').innerHTML = `
        <div class="result-card">
          <h3>ğŸ’¡ è¨ˆç®—çµæœ</h3>
          <div class="result-item">
            <span>ç¸½æˆæœ¬</span>
            <span>${totalCost.toFixed(0)} å…ƒ</span>
          </div>
          <div class="result-item">
            <span>ç¸½è²»ç‡</span>
            <span>${totalFeeRate.toFixed(1)}%</span>
          </div>
          <div class="result-item">
            <span>å»ºè­°å”®åƒ¹</span>
            <span>${Math.ceil(suggestedPrice)} å…ƒ</span>
          </div>
          <div class="result-item">
            <span>é ä¼°æ·¨æ”¶å…¥</span>
            <span>${netIncome.toFixed(0)} å…ƒ</span>
          </div>
          <div class="result-item">
            <span>é ä¼°åˆ©æ½¤</span>
            <span>${profit.toFixed(0)} å…ƒï¼ˆ${actualMargin.toFixed(1)}%ï¼‰</span>
          </div>
        </div>
      `;
    }

    async function loadSheetsList() {
      console.log('âœ… loadSheetsList å‡½æ•¸è¢«å‘¼å«');
      
      const sheetsUrl = document.getElementById('sheetsId').value;
      
      if (!sheetsUrl) {
        alert('âš ï¸ è«‹å…ˆè¼¸å…¥ Google Sheets å®Œæ•´ç¶²å€ï¼\n\nç¯„ä¾‹ï¼šhttps://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit');
        return;
      }
      
      const match = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (!match) {
        alert('âš ï¸ ç¶²å€æ ¼å¼ä¸æ­£ç¢ºï¼\n\nè«‹ç¢ºèªæ‚¨è¤‡è£½äº†å®Œæ•´çš„ Google Sheets ç¶²å€');
        return;
      }
      
      const sheetsId = match[1];
      console.log('âœ… Sheets ID:', sheetsId);
      
      localStorage.setItem('sheetsUrl', sheetsUrl);
      localStorage.setItem('sheetsId', sheetsId);
      
      document.getElementById('connectionResult').innerHTML = `
        <div class="ai-suggestion" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <p style="color: white; margin: 0;">â³ æ­£åœ¨è§£æè©¦ç®—è¡¨...</p>
        </div>
      `;
      
      promptForSheetNames(sheetsId);
    }

    function promptForSheetNames(sheetsId) {
      document.getElementById('connectionResult').innerHTML = `
        <div class="cost-card" style="margin-top: 20px;">
          <h3 style="color: #2563eb; margin-bottom: 15px;">ğŸ“ è«‹è¼¸å…¥æ‚¨çš„å·¥ä½œè¡¨åç¨±</h3>
          
          <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
            <p style="margin: 0 0 10px 0; color: #92400e; font-weight: 600;">ğŸ’¡ å¦‚ä½•æ‰¾åˆ°å·¥ä½œè¡¨åç¨±ï¼Ÿ</p>
            <ol style="margin: 0; padding-left: 20px; color: #78350f;">
              <li>æ‰“é–‹æ‚¨çš„ Google Sheets</li>
              <li>çœ‹<strong>å·¦ä¸‹è§’</strong>çš„æ¨™ç±¤åç¨±</li>
              <li>é€å€‹è¼¸å…¥åˆ°ä¸‹æ–¹æ¬„ä½ä¸­</li>
            </ol>
          </div>
          
          <div id="sheetNameInputs">
            <div class="input-group" style="margin-bottom: 10px;">
              <label>å·¥ä½œè¡¨ 1ï¼š</label>
              <input type="text" id="sheetName1" placeholder="ä¾‹å¦‚ï¼šæ™ºåŒ_ç”¢å“åº«" 
                     style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>
            <div class="input-group" style="margin-bottom: 10px;">
              <label>å·¥ä½œè¡¨ 2ï¼š</label>
              <input type="text" id="sheetName2" placeholder="ä¾‹å¦‚ï¼šæ—­ç…Œ_ç”¢å“åº«" 
                     style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn" onclick="addMoreSheetInput()" 
                    style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
              â• æ–°å¢æ›´å¤šå·¥ä½œè¡¨
            </button>
            <button class="btn" onclick="saveAndLoadSheets()" 
                    style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
              ğŸ’¾ ä¿å­˜ä¸¦è¼‰å…¥å·¥ä½œè¡¨
            </button>
          </div>
        </div>
      `;
    }

    function addMoreSheetInput() {
      sheetInputCount++;
      const container = document.getElementById('sheetNameInputs');
      const newInput = document.createElement('div');
      newInput.className = 'input-group';
      newInput.style = 'margin-bottom: 10px;';
      newInput.innerHTML = `
        <label>å·¥ä½œè¡¨ ${sheetInputCount}ï¼š</label>
        <input type="text" id="sheetName${sheetInputCount}" placeholder="è¼¸å…¥å·¥ä½œè¡¨åç¨±" 
               style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
      `;
      container.appendChild(newInput);
    }

    async function saveAndLoadSheets() {
      const sheetsId = localStorage.getItem('sheetsId');
      const sheetNames = [];
      
      for (let i = 1; i <= sheetInputCount; i++) {
        const input = document.getElementById(`sheetName${i}`);
        if (input && input.value.trim()) {
          sheetNames.push(input.value.trim());
        }
      }
      
      if (sheetNames.length === 0) {
        alert('âš ï¸ è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹å·¥ä½œè¡¨åç¨±ï¼');
        return;
      }
      
      console.log('âœ… ä¿å­˜çš„å·¥ä½œè¡¨åç¨±:', sheetNames);
      
      localStorage.setItem('userSheetNames', JSON.stringify(sheetNames));
      
      document.getElementById('connectionResult').innerHTML = `
        <div class="ai-suggestion" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <p style="color: white; margin: 0;">â³ æ­£åœ¨è®€å– ${sheetNames.length} å€‹å·¥ä½œè¡¨çš„æ•¸æ“š...</p>
        </div>
      `;
      
      availableSheets = [];
      
      for (const sheetName of sheetNames) {
        try {
          const data = await fetchSheetData(sheetsId, sheetName);
          availableSheets.push({
            name: sheetName,
            type: 'product',
            count: data.length,
            desc: `åŒ…å« ${data.length} ç­†è³‡æ–™`,
            data: data
          });
          console.log(`âœ… ${sheetName}: ${data.length} ç­†è³‡æ–™`);
        } catch (error) {
          console.error(`âŒ ç„¡æ³•è®€å– ${sheetName}:`, error);
          availableSheets.push({
            name: sheetName,
            type: 'product',
            count: 0,
            desc: 'è®€å–å¤±æ•—',
            data: []
          });
        }
      }
      
      displaySheetsList();
      
      console.log('âœ… å·¥ä½œè¡¨æ¸…å–®å·²é¡¯ç¤ºï¼Œå…±', availableSheets.length, 'å€‹å·¥ä½œè¡¨');
    }

    async function fetchSheetData(sheetsId, sheetName) {
      console.log(`ğŸ“¥ å˜—è©¦è®€å–å·¥ä½œè¡¨: ${sheetName}`);
      
      try {
        // ä½¿ç”¨ Google Sheets çš„å…¬é–‹ APIï¼ˆä¸éœ€è¦èªè­‰ï¼‰
        const encodedSheetName = encodeURIComponent(sheetName);
        const url = `https://docs.google.com/spreadsheets/d/${sheetsId}/gviz/tq?tqx=out:json&sheet=${encodedSheetName}`;
        
        console.log(`ğŸŒ è«‹æ±‚ URL: ${url}`);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const text = await response.text();
        
        // Google è¿”å›çš„æ˜¯ JSONP æ ¼å¼ï¼Œéœ€è¦æå– JSON éƒ¨åˆ†
        const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\);?/)[1];
        const data = JSON.parse(jsonString);
        
        console.log(`âœ… åŸå§‹æ•¸æ“šçµæ§‹:`, data);
        console.log(`ğŸ“Š æ¬„ä½æ•¸é‡: ${data.table.cols.length}`);
        console.log(`ğŸ“Š åŸå§‹åˆ—æ•¸: ${data.table.rows.length}`);
        
        if (!data.table || !data.table.rows || data.table.rows.length === 0) {
          console.warn(`âš ï¸ å·¥ä½œè¡¨ ${sheetName} æ²’æœ‰æ•¸æ“š`);
          return [];
        }
        
        // è§£æè¡¨æ ¼æ•¸æ“š
        const cols = data.table.cols;
        const rows = data.table.rows;
        
        console.log(`ğŸ“‹ è¡¨é ­è³‡è¨Š:`, cols.map(c => c.label));
        
        // è½‰æ›æˆæ˜“ç”¨çš„ç‰©ä»¶é™£åˆ—ï¼ˆåŒ…å«æ‰€æœ‰åˆ—ï¼Œä¸è·³éç©ºå€¼ï¼‰
        const parsedData = [];
        
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const obj = {};
          let hasData = false;
          
          cols.forEach((col, index) => {
            const cell = row.c[index];
            const colLabel = col.label || `æ¬„ä½${index + 1}`;
            
            // å–å¾—å„²å­˜æ ¼çš„å€¼
            let value = '';
            if (cell) {
              if (cell.v !== null && cell.v !== undefined) {
                value = cell.v;
                hasData = true;
              } else if (cell.f) {
                value = cell.f;
                hasData = true;
              }
            }
            
            obj[colLabel] = value;
          });
          
          // å³ä½¿æŸåˆ—å…¨æ˜¯ç©ºå€¼ï¼Œä¹ŸåŒ…å«é€²ä¾†ï¼ˆé™¤éå®Œå…¨æ²’æœ‰è³‡æ–™ï¼‰
          parsedData.push(obj);
        }
        
        console.log(`âœ… ${sheetName} è§£æå®Œæˆ: ${parsedData.length} ç­†è³‡æ–™`);
        console.log(`ğŸ“Š å‰ 3 ç­†ç¯„ä¾‹è³‡æ–™:`, parsedData.slice(0, 3));
        
        // éæ¿¾æ‰å®Œå…¨ç©ºç™½çš„åˆ—
        const filteredData = parsedData.filter(row => {
          return Object.values(row).some(val => val !== '' && val !== null && val !== undefined);
        });
        
        console.log(`âœ… éæ¿¾å¾Œ: ${filteredData.length} ç­†æœ‰æ•ˆè³‡æ–™`);
        
        return filteredData;
        
      } catch (error) {
        console.error(`âŒ è®€å– ${sheetName} å¤±æ•—:`, error);
        console.error(`âŒ å®Œæ•´éŒ¯èª¤:`, error.stack);
        
        // å¦‚æœå¤±æ•—ï¼Œæä¾›è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
        if (error.message.includes('HTTP error')) {
          console.error('å¯èƒ½åŸå› ï¼šå·¥ä½œè¡¨åç¨±ä¸æ­£ç¢ºï¼Œæˆ– Google Sheets æœªè¨­ç‚ºå…¬é–‹');
        } else if (error.message.includes('match')) {
          console.error('å¯èƒ½åŸå› ï¼šç„¡æ³•è§£æ Google è¿”å›çš„æ•¸æ“šæ ¼å¼');
        }
        
        // è¿”å›ç©ºé™£åˆ—è€Œä¸æ˜¯æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ç¨‹å¼ç¹¼çºŒé‹è¡Œ
        return [];
      }
    }

    function displaySheetsList() {
      const productSheets = availableSheets.filter(s => s.type === 'product');
      
      const html = `
        <div class="cost-card" style="margin-top: 20px;">
          <h3 style="color: #2563eb;">ğŸ“‹ é¸æ“‡è¦åˆ†æçš„å·¥ä½œè¡¨</h3>
          <p style="color: #6c757d; margin-bottom: 20px;">å‹¾é¸æ‚¨æƒ³è¦ç´å…¥åˆ†æçš„ç”¢å“åº«ï¼ˆå¯å¤šé¸ï¼‰</p>
          
          ${productSheets.map(sheet => `
            <div class="sheet-item" onclick="toggleSheet('${sheet.name}')">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" class="sheet-checkbox" id="check_${sheet.name}" 
                       onchange="updateSelectedSheets()">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #495057; margin-bottom: 5px;">
                    ğŸ·ï¸ ${sheet.name}
                  </div>
                  <div style="font-size: 0.9rem; color: #6c757d;">
                    ${sheet.count} ç­†è³‡æ–™
                  </div>
                  <div style="font-size: 0.85rem; color: #adb5bd;">
                    ${sheet.desc}
                  </div>
                </div>
              </label>
            </div>
          `).join('')}
          
          <button class="btn" onclick="confirmSelection()" style="margin-top: 20px; width: 100%;">
            âœ… ç¢ºèªé¸æ“‡ä¸¦è¼‰å…¥æ•¸æ“š
          </button>
        </div>
      `;
      
      document.getElementById('sheetsList').innerHTML = html;
    }

    function toggleSheet(sheetName) {
      const checkbox = document.getElementById(`check_${sheetName}`);
      checkbox.checked = !checkbox.checked;
      updateSelectedSheets();
    }

    function updateSelectedSheets() {
      selectedSheets = [];
      availableSheets.forEach(sheet => {
        const checkbox = document.getElementById(`check_${sheet.name}`);
        if (checkbox && checkbox.checked) {
          selectedSheets.push(sheet);
        }
      });
    }

    function confirmSelection() {
      if (selectedSheets.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å·¥ä½œè¡¨ï¼');
        return;
      }
      
      const totalCount = selectedSheets.reduce((sum, s) => sum + s.count, 0);
      
      // åˆä½µæ‰€æœ‰é¸ä¸­å·¥ä½œè¡¨çš„ç”¢å“æ•¸æ“š
      allProducts = [];
      selectedSheets.forEach(sheet => {
        if (sheet.data && sheet.data.length > 0) {
          sheet.data.forEach(product => {
            allProducts.push({
              ...product,
              ä¾†æº: sheet.name,
              å»ºè­°å”®åƒ¹: null,
              é ä¼°åˆ©æ½¤: null
            });
          });
        }
      });
      
      console.log('âœ… å·²è¼‰å…¥ç”¢å“æ•¸æ“š:', allProducts.length, 'ç­†');
      
      // æ›´æ–°å¿«é€Ÿé¸æ“‡å™¨
      updateQuickSelect();
      
      document.getElementById('connectionResult').innerHTML = `
        <div class="ai-suggestion" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);">
          <h3 style="color: #2d5016;">âœ… å·²é¸æ“‡ ${selectedSheets.length} å€‹å·¥ä½œè¡¨</h3>
          <p style="color: #3e6b1f; margin: 10px 0;">
            ç¸½å…± <strong>${totalCount} ç­†ç”¢å“æ•¸æ“š</strong> å·²è¼‰å…¥ï¼
          </p>
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
            <strong style="color: #2d5016;">å·²é¸æ“‡çš„å·¥ä½œè¡¨ï¼š</strong><br>
            ${selectedSheets.map(s => `â€¢ ${s.name} (${s.count} ç­†)`).join('<br>')}
          </div>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn" onclick="navigateToAnalysis()" 
                    style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
              ğŸ“Š ç”¢å“åˆ†æ
            </button>
            <button class="btn" onclick="navigateToCalculator()" 
                    style="flex: 1; background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
              ğŸ’° é–‹å§‹å®šåƒ¹
            </button>
          </div>
        </div>
      `;
      
      console.log('âœ… ç¢ºèªé¸æ“‡:', selectedSheets);
    }

    function checkSavedSheets() {
      const savedSheets = localStorage.getItem('userSheetNames');
      const savedUrl = localStorage.getItem('sheetsUrl');
      
      if (savedSheets && savedUrl) {
        const sheetsList = JSON.parse(savedSheets);
        
        setTimeout(() => {
          const connectionResult = document.getElementById('connectionResult');
          if (connectionResult && connectionResult.innerHTML.trim() === '') {
            connectionResult.innerHTML = `
              <div class="ai-suggestion" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); border-left: 5px solid #28a745; margin-bottom: 20px;">
                <h4 style="color: #2d5016; margin-bottom: 10px;">âœ… æ‰¾åˆ°å·²ä¿å­˜çš„è¨­å®š</h4>
                <p style="color: #3e6b1f; margin-bottom: 15px;">
                  å·²ä¿å­˜ <strong>${sheetsList.length} å€‹å·¥ä½œè¡¨</strong>ï¼š${sheetsList.join('ã€')}
                </p>
                <button class="btn" onclick="quickLoadSavedSheets()" 
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  âš¡ å¿«é€Ÿè¼‰å…¥å·²ä¿å­˜çš„å·¥ä½œè¡¨
                </button>
              </div>
            `;
          }
        }, 100);
      }
    }

    async function quickLoadSavedSheets() {
      const savedSheets = JSON.parse(localStorage.getItem('userSheetNames'));
      const sheetsId = localStorage.getItem('sheetsId');
      
      document.getElementById('connectionResult').innerHTML = `
        <div class="ai-suggestion" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
          <p style="color: white; margin: 0;">â³ æ­£åœ¨è®€å– ${savedSheets.length} å€‹å·¥ä½œè¡¨çš„æ•¸æ“š...</p>
        </div>
      `;
      
      availableSheets = [];
      
      for (const sheetName of savedSheets) {
        try {
          const data = await fetchSheetData(sheetsId, sheetName);
          availableSheets.push({
            name: sheetName,
            type: 'product',
            count: data.length,
            desc: `åŒ…å« ${data.length} ç­†è³‡æ–™`,
            data: data
          });
          console.log(`âœ… ${sheetName}: ${data.length} ç­†è³‡æ–™`);
        } catch (error) {
          console.error(`âŒ ç„¡æ³•è®€å– ${sheetName}:`, error);
          availableSheets.push({
            name: sheetName,
            type: 'product',
            count: 0,
            desc: 'è®€å–å¤±æ•—',
            data: []
          });
        }
      }
      
      displaySheetsList();
      
      console.log('âœ… å¿«é€Ÿè¼‰å…¥å®Œæˆï¼Œå…±', availableSheets.length, 'å€‹å·¥ä½œè¡¨');
    }

    function navigateToAnalysis() {
      showTab('analysis');
    }

    function navigateToCalculator() {
      showTab('calculator');
    }

    function displayAnalysisPage() {
      if (allProducts.length === 0) {
        return;
      }
      
      document.getElementById('productDataSection').style.display = 'none';
      document.getElementById('analysisContent').style.display = 'block';
      
      // é¡¯ç¤ºæ•¸æ“šæ¦‚è¦½
      displayDataOverview();
      
      // è¨­ç½®ä¾†æºç¯©é¸å™¨
      const sources = [...new Set(allProducts.map(p => p.ä¾†æº))];
      const sourceFilter = document.getElementById('sourceFilter');
      sourceFilter.innerHTML = '<option value="">å…¨éƒ¨ä¾†æº</option>' + 
        sources.map(s => `<option value="${s}">${s}</option>`).join('');
      
      // é¡¯ç¤ºç”¢å“è¡¨æ ¼
      filteredProducts = [...allProducts];
      displayProductTable();
      
      // é¡¯ç¤ºåƒ¹æ ¼åˆ†æ
      displayPriceAnalysis();
    }

    function displayDataOverview() {
      const overview = document.getElementById('dataOverview');
      const totalProducts = allProducts.length;
      const sources = [...new Set(allProducts.map(p => p.ä¾†æº))];
      
      // è¨ˆç®—å¹³å‡æˆæœ¬ï¼ˆå‡è¨­æ¬„ä½åç¨±å¯èƒ½æ˜¯ã€Œå–®åƒ¹ã€æˆ–ã€Œé€²è²¨å–®åƒ¹ã€ï¼‰
      const costs = allProducts.map(p => {
        const price = p['å–®åƒ¹'] || p['é€²è²¨å–®åƒ¹'] || p['æˆæœ¬'] || 0;
        return typeof price === 'number' ? price : parseFloat(price) || 0;
      }).filter(c => c > 0);
      
      const avgCost = costs.length > 0 ? (costs.reduce((a, b) => a + b, 0) / costs.length).toFixed(0) : 0;
      const maxCost = costs.length > 0 ? Math.max(...costs) : 0;
      const minCost = costs.length > 0 ? Math.min(...costs) : 0;
      
      overview.innerHTML = `
        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${totalProducts}</div>
          <div style="color: #6c757d;">ç¸½ç”¢å“æ•¸</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #f093fb;">${sources.length}</div>
          <div style="color: #6c757d;">ç”¢å“åº«æ•¸é‡</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="font-size: 1.5rem; font-weight: bold; color: #84fab0;">${avgCost} å…ƒ</div>
          <div style="color: #6c757d;">å¹³å‡æˆæœ¬</div>
        </div>
        <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
          <div style="font-size: 1.2rem; font-weight: bold; color: #fbc2eb;">${minCost} - ${maxCost} å…ƒ</div>
          <div style="color: #6c757d;">æˆæœ¬ç¯„åœ</div>
        </div>
      `;
    }

    function displayProductTable() {
      const table = document.getElementById('productTable');
      const thead = document.getElementById('tableHeader');
      const tbody = document.getElementById('tableBody');
      
      if (filteredProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 30px; color: #6c757d;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç”¢å“</td></tr>';
        return;
      }
      
      // å–å¾—æ‰€æœ‰æ¬„ä½
      const allKeys = new Set();
      filteredProducts.forEach(product => {
        Object.keys(product).forEach(key => allKeys.add(key));
      });
      
      const keys = Array.from(allKeys);
      
      // å»ºç«‹è¡¨é ­
      thead.innerHTML = `
        <th style="padding: 12px; border: 1px solid #e5e7eb; background: #f8f9fa;">
          <input type="checkbox" onchange="toggleAllProducts(this)" style="width: 18px; height: 18px;">
        </th>
        ${keys.map(key => `
          <th style="padding: 12px; border: 1px solid #e5e7eb; white-space: nowrap; cursor: pointer;" 
              onclick="sortTable('${key}')">
            ${key} â†•ï¸
          </th>
        `).join('')}
      `;
      
      // åˆ†é 
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageProducts = filteredProducts.slice(startIndex, endIndex);
      
      // å»ºç«‹è¡¨æ ¼å…§å®¹
      tbody.innerHTML = pageProducts.map((product, index) => {
        const globalIndex = startIndex + index;
        const isSelected = selectedProducts.has(globalIndex);
        
        return `
          <tr style="background: ${isSelected ? '#f0f4ff' : 'white'};">
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">
              <input type="checkbox" ${isSelected ? 'checked' : ''} 
                     onchange="toggleProduct(${globalIndex}, this)" 
                     style="width: 18px; height: 18px;">
            </td>
            ${keys.map(key => {
              let value = product[key] || '';
              
              // å¦‚æœæ˜¯æ•¸å­—é¡å‹çš„æ¬„ä½ï¼Œå³å°é½Š
              const isNumber = typeof value === 'number' || !isNaN(parseFloat(value));
              
              // ç‰¹æ®Šé¡¯ç¤ºï¼šå»ºè­°å”®åƒ¹å’Œé ä¼°åˆ©æ½¤
              if (key === 'å»ºè­°å”®åƒ¹' && value) {
                value = `<strong style="color: #667eea;">${Math.ceil(value)} å…ƒ</strong>`;
              } else if (key === 'é ä¼°åˆ©æ½¤' && value) {
                const color = value > 0 ? '#28a745' : '#dc3545';
                value = `<strong style="color: ${color};">${value.toFixed(0)} å…ƒ</strong>`;
              }
              
              return `
                <td style="padding: 12px; border: 1px solid #e5e7eb; ${isNumber ? 'text-align: right;' : ''} white-space: nowrap;">
                  ${value}
                </td>
              `;
            }).join('')}
          </tr>
        `;
      }).join('');
      
      // åˆ†é æ§åˆ¶
      displayPagination();
    }

    function displayPagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      const pagination = document.getElementById('tablePagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let html = `
        <button class="btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
          â† ä¸Šä¸€é 
        </button>
        <span style="margin: 0 15px;">ç¬¬ ${currentPage} / ${totalPages} é ï¼ˆå…± ${filteredProducts.length} ç­†ï¼‰</span>
        <button class="btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
          ä¸‹ä¸€é  â†’
        </button>
      `;
      
      pagination.innerHTML = html;
    }

    function changePage(page) {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      displayProductTable();
    }

    function filterProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sourceFilter = document.getElementById('sourceFilter').value;
      
      filteredProducts = allProducts.filter(product => {
        // æœå°‹æ¢ä»¶
        const matchSearch = !searchTerm || Object.values(product).some(val => 
          String(val).toLowerCase().includes(searchTerm)
        );
        
        // ä¾†æºæ¢ä»¶
        const matchSource = !sourceFilter || product.ä¾†æº === sourceFilter;
        
        return matchSearch && matchSource;
      });
      
      currentPage = 1;
      displayProductTable();
    }

    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('sourceFilter').value = '';
      filterProducts();
    }

    function toggleProduct(index, checkbox) {
      if (checkbox.checked) {
        selectedProducts.add(index);
      } else {
        selectedProducts.delete(index);
      }
      displayProductTable();
    }

    function toggleAllProducts(checkbox) {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      
      for (let i = startIndex; i < endIndex && i < filteredProducts.length; i++) {
        if (checkbox.checked) {
          selectedProducts.add(i);
        } else {
          selectedProducts.delete(i);
        }
      }
      displayProductTable();
    }

    function selectAllProducts() {
      for (let i = 0; i < filteredProducts.length; i++) {
        selectedProducts.add(i);
      }
      displayProductTable();
    }

    function deselectAllProducts() {
      selectedProducts.clear();
      displayProductTable();
    }

    function calculateBatchPricing() {
      const packaging = parseFloat(document.getElementById('batchPackaging').value) || 0;
      const labor = parseFloat(document.getElementById('batchLabor').value) || 0;
      const targetMargin = parseFloat(document.getElementById('batchMargin').value) || 0;
      
      const isActivity = document.getElementById('batchActivity').checked;
      const hasFreeShipping = document.getElementById('batchFreeShip').checked;
      const isPreorder = document.getElementById('batchPreorder').checked;
      const hasCoins = document.getElementById('batchCoins').checked;
      
      let totalFeeRate = isActivity ? 7.5 : 5.5;
      totalFeeRate += 2.0; // é‡‘æµè²»
      if (hasFreeShipping) totalFeeRate += 7;
      if (isPreorder) totalFeeRate += 3;
      if (hasCoins) totalFeeRate += 3;
      
      let calculated = 0;
      
      filteredProducts.forEach((product, index) => {
        // å–å¾—æˆæœ¬ï¼ˆå˜—è©¦ä¸åŒçš„æ¬„ä½åç¨±ï¼‰
        const cost = parseFloat(product['å–®åƒ¹'] || product['é€²è²¨å–®åƒ¹'] || product['æˆæœ¬'] || 0);
        
        if (cost > 0) {
          const totalCost = cost + packaging + labor;
          const suggestedPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
          const netIncome = suggestedPrice * (1 - totalFeeRate / 100);
          const profit = netIncome - totalCost;
          
          product.å»ºè­°å”®åƒ¹ = suggestedPrice;
          product.é ä¼°åˆ©æ½¤ = profit;
          calculated++;
        }
      });
      
      alert(`âœ… å·²è¨ˆç®— ${calculated} å€‹ç”¢å“çš„å»ºè­°å”®åƒ¹ï¼`);
      displayProductTable();
      displayPriceAnalysis();
    }

    function displayPriceAnalysis() {
      const analysisDiv = document.getElementById('priceAnalysis');
      
      // å–å¾—æœ‰æˆæœ¬çš„ç”¢å“
      const productsWithCost = filteredProducts.filter(p => {
        const cost = parseFloat(p['å–®åƒ¹'] || p['é€²è²¨å–®åƒ¹'] || p['æˆæœ¬'] || 0);
        return cost > 0;
      });
      
      if (productsWithCost.length === 0) {
        analysisDiv.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 30px;">æš«ç„¡åƒ¹æ ¼æ•¸æ“š</p>';
        return;
      }
      
      // åƒ¹æ ¼åˆ†ä½ˆçµ±è¨ˆ
      const priceRanges = {
        '0-100': 0,
        '101-200': 0,
        '201-300': 0,
        '301-500': 0,
        '500+': 0
      };
      
      productsWithCost.forEach(p => {
        const cost = parseFloat(p['å–®åƒ¹'] || p['é€²è²¨å–®åƒ¹'] || p['æˆæœ¬'] || 0);
        if (cost <= 100) priceRanges['0-100']++;
        else if (cost <= 200) priceRanges['101-200']++;
        else if (cost <= 300) priceRanges['201-300']++;
        else if (cost <= 500) priceRanges['301-500']++;
        else priceRanges['500+']++;
      });
      
      const maxCount = Math.max(...Object.values(priceRanges));
      
      analysisDiv.innerHTML = `
        <div style="margin-bottom: 15px;">
          <strong>æˆæœ¬åƒ¹æ ¼åˆ†ä½ˆï¼š</strong>
        </div>
        ${Object.entries(priceRanges).map(([range, count]) => {
          const percentage = maxCount > 0 ? (count / maxCount * 100) : 0;
          return `
            <div style="margin-bottom: 10px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${range} å…ƒ</span>
                <span><strong>${count}</strong> å€‹ç”¢å“</span>
              </div>
              <div style="background: #e5e7eb; border-radius: 10px; height: 25px; overflow: hidden;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            width: ${percentage}%; height: 100%; 
                            transition: width 0.5s; border-radius: 10px;"></div>
              </div>
            </div>
          `;
        }).join('')}
      `;
    }

    function sortTable(key) {
      const isAscending = filteredProducts[0] && filteredProducts[0]._sortKey === key && filteredProducts[0]._sortAsc;
      
      filteredProducts.sort((a, b) => {
        let valA = a[key] || '';
        let valB = b[key] || '';
        
        // å˜—è©¦è½‰æ›ç‚ºæ•¸å­—
        const numA = parseFloat(valA);
        const numB = parseFloat(valB);
        
        if (!isNaN(numA) && !isNaN(numB)) {
          return isAscending ? numB - numA : numA - numB;
        }
        
        // å­—ä¸²æ¯”è¼ƒ
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
        
        if (isAscending) {
          return valB.localeCompare(valA);
        } else {
          return valA.localeCompare(valB);
        }
      });
      
      // è¨˜éŒ„æ’åºç‹€æ…‹
      filteredProducts.forEach(p => {
        p._sortKey = key;
        p._sortAsc = !isAscending;
      });
      
      displayProductTable();
    }

    function exportToCSV() {
      if (filteredProducts.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼');
        return;
      }
      
      // å–å¾—æ‰€æœ‰æ¬„ä½
      const keys = Object.keys(filteredProducts[0]);
      
      // å»ºç«‹ CSV å…§å®¹
      let csv = keys.join(',') + '\n';
      
      filteredProducts.forEach(product => {
        const row = keys.map(key => {
          let value = product[key] || '';
          // å¦‚æœåŒ…å«é€—è™Ÿï¼Œç”¨å¼•è™ŸåŒ…èµ·ä¾†
          if (String(value).includes(',')) {
            value = `"${value}"`;
          }
          return value;
        });
        csv += row.join(',') + '\n';
      });
      
      // ä¸‹è¼‰æª”æ¡ˆ
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ç”¢å“è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    window.onload = function() {
      console.log('âœ… é é¢è¼‰å…¥å®Œæˆ');
      console.log('âœ… æ‰€æœ‰å‡½æ•¸å·²å®šç¾©');
      
      updateFeeRateDisplay();
      checkSavedSheets();
      updateQuickSelect();
      
      const cost = document.getElementById('cost').value;
      if (cost) {
        calculate();
      }
    };

    function updateQuickSelect() {
      const quickSelectDiv = document.getElementById('quickSelectProduct');
      
      if (allProducts.length === 0) {
        quickSelectDiv.innerHTML = '<p style="color: #4a5568;">è«‹å…ˆå‰å¾€ã€ŒğŸ”— è³‡æ–™æ•´åˆã€è¼‰å…¥ç”¢å“è³‡æ–™</p>';
        return;
      }
      
      // å»ºç«‹ç”¢å“é¸æ“‡å™¨
      const productsWithCost = allProducts.filter(p => {
        const cost = parseFloat(p['å–®åƒ¹'] || p['é€²è²¨å–®åƒ¹'] || p['æˆæœ¬'] || 0);
        return cost > 0;
      });
      
      if (productsWithCost.length === 0) {
        quickSelectDiv.innerHTML = '<p style="color: #4a5568;">ç”¢å“è³‡æ–™ä¸­æ²’æœ‰æ‰¾åˆ°æˆæœ¬è³‡è¨Š</p>';
        return;
      }
      
      quickSelectDiv.innerHTML = `
        <div class="input-group" style="margin: 0;">
          <label style="color: #2d3748; font-weight: 600;">å¾ç”¢å“åº«é¸æ“‡ï¼š</label>
          <select id="productSelector" onchange="loadProductData()" 
                  style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
            <option value="">-- è«‹é¸æ“‡ç”¢å“ --</option>
            ${productsWithCost.map((product, index) => {
              const name = product['å•†å“åç¨±'] || product['ç”¢å“åç¨±'] || `ç”¢å“ ${index + 1}`;
              const code = product['ç”¢å“ç·¨è™Ÿ'] || product['å•†å“ç·¨è™Ÿ'] || '';
              const cost = parseFloat(product['å–®åƒ¹'] || product['é€²è²¨å–®åƒ¹'] || product['æˆæœ¬'] || 0);
              const source = product['ä¾†æº'] || '';
              
              return `<option value="${index}">[${source}] ${code} ${name} - ${cost} å…ƒ</option>`;
            }).join('')}
          </select>
        </div>
      `;
    }

    function loadProductData() {
      const selector = document.getElementById('productSelector');
      const selectedIndex = parseInt(selector.value);
      
      if (isNaN(selectedIndex)) return;
      
      const productsWithCost = allProducts.filter(p => {
        const cost = parseFloat(p['å–®åƒ¹'] || p['é€²è²¨å–®åƒ¹'] || p['æˆæœ¬'] || 0);
        return cost > 0;
      });
      
      const product = productsWithCost[selectedIndex];
      if (!product) return;
      
      // è¼‰å…¥ç”¢å“æˆæœ¬åˆ°è¨ˆç®—å™¨
      const cost = parseFloat(product['å–®åƒ¹'] || product['é€²è²¨å–®åƒ¹'] || product['æˆæœ¬'] || 0);
      document.getElementById('cost').value = cost;
      document.getElementById('quantity').value = 1;
      
      // è‡ªå‹•è¨ˆç®—
      calculate();
      
      // é¡¯ç¤ºæç¤º
      alert(`âœ… å·²è¼‰å…¥ç”¢å“ï¼š${product['å•†å“åç¨±'] || product['ç”¢å“åç¨±']}\næˆæœ¬ï¼š${cost} å…ƒ`);
    }

    // ==================== ç«¶å“ç›£æ§åŠŸèƒ½ ====================

    function updateCompetitorPage() {
      console.log('ğŸ¯ æ›´æ–°ç«¶å“ç›£æ§é é¢');
      
      // æ›´æ–°ç”¢å“é¸æ“‡å™¨
      updateMyProductSelector();
      
      // æ›´æ–°ç«¶å“è¡¨æ ¼
      displayCompetitorTable();
      
      // æ›´æ–°æ¦‚è¦½
      updateCompetitorOverview();
      
      // æ›´æ–°åˆ†æåœ–è¡¨
      updateCompetitiveAnalysis();
      
      // æ›´æ–°åƒ¹æ ¼è­¦ç¤º
      updatePriceAlerts();
    }

    function updateMyProductSelector() {
      const selector = document.getElementById('myProductSelect');
      
      if (!selector) return;
      
      if (allProducts.length === 0) {
        selector.innerHTML = '<option value="">è«‹å…ˆè¼‰å…¥ç”¢å“è³‡æ–™</option>';
        return;
      }
      
      // ç‚ºç”¢å“è¨­å®šå»ºè­°å”®åƒ¹ï¼ˆå¦‚æœå·²ç¶“è¨ˆç®—éï¼‰
      const productsWithPrice = allProducts.map((product, index) => {
        const name = product['å•†å“åç¨±'] || product['ç”¢å“åç¨±'] || `ç”¢å“ ${index + 1}`;
        const code = product['ç”¢å“ç·¨è™Ÿ'] || product['å•†å“ç·¨è™Ÿ'] || '';
        const price = product['å»ºè­°å”®åƒ¹'] || calculateQuickPrice(product);
        
        return {
          index,
          name,
          code,
          price: Math.ceil(price),
          source: product['ä¾†æº'] || ''
        };
      });
      
      selector.innerHTML = '<option value="">-- è«‹é¸æ“‡ç”¢å“ --</option>' +
        productsWithPrice.map(p => 
          `<option value="${p.index}" data-price="${p.price}">[${p.source}] ${p.code} ${p.name} - ${p.price} å…ƒ</option>`
        ).join('');
      
      // ç›£è½é¸æ“‡è®ŠåŒ–
      selector.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        const price = selectedOption.getAttribute('data-price');
        document.getElementById('myPrice').value = price || '';
      };
    }

    function calculateQuickPrice(product) {
      const cost = parseFloat(product['å–®åƒ¹'] || product['é€²è²¨å–®åƒ¹'] || product['æˆæœ¬'] || 0);
      if (cost === 0) return 0;
      
      // ä½¿ç”¨é è¨­åƒæ•¸å¿«é€Ÿè¨ˆç®—
      const packaging = 10;
      const labor = 20;
      const totalCost = cost + packaging + labor;
      const targetMargin = 30;
      const totalFeeRate = 5.5 + 2.0; // åŸºæœ¬æ‰‹çºŒè²» + é‡‘æµè²»
      
      return totalCost / (1 - (totalFeeRate + targetMargin) / 100);
    }

    function addCompetitor() {
      const myProductIndex = document.getElementById('myProductSelect').value;
      const myPrice = parseFloat(document.getElementById('myPrice').value);
      const compName = document.getElementById('compName').value.trim();
      const compPrice = parseFloat(document.getElementById('compPrice').value);
      const compUrl = document.getElementById('compUrl').value.trim();
      
      if (!myProductIndex) {
        alert('âŒ è«‹é¸æ“‡æˆ‘æ–¹ç”¢å“ï¼');
        return;
      }
      
      if (!compName) {
        alert('âŒ è«‹è¼¸å…¥ç«¶å“åç¨±ï¼');
        return;
      }
      
      if (!compPrice || compPrice <= 0) {
        alert('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ç«¶å“åƒ¹æ ¼ï¼');
        return;
      }
      
      const myProduct = allProducts[parseInt(myProductIndex)];
      const myProductName = myProduct['å•†å“åç¨±'] || myProduct['ç”¢å“åç¨±'] || 'æœªå‘½åç”¢å“';
      const myProductCode = myProduct['ç”¢å“ç·¨è™Ÿ'] || myProduct['å•†å“ç·¨è™Ÿ'] || '';
      
      // è¨ˆç®—åƒ¹å·®
      const priceDiff = myPrice - compPrice;
      const priceDiffPercent = ((priceDiff / compPrice) * 100).toFixed(1);
      
      // æ·»åŠ åˆ°ç«¶å“è³‡æ–™
      competitorData.push({
        myProductIndex: parseInt(myProductIndex),
        myProductName,
        myProductCode,
        myPrice,
        compName,
        compPrice,
        compUrl,
        priceDiff,
        priceDiffPercent,
        addedDate: new Date().toISOString()
      });
      
      console.log('âœ… æ·»åŠ ç«¶å“:', competitorData[competitorData.length - 1]);
      
      // æ¸…ç©ºè¼¸å…¥
      document.getElementById('compName').value = '';
      document.getElementById('compPrice').value = '';
      document.getElementById('compUrl').value = '';
      
      // æ›´æ–°é¡¯ç¤º
      displayCompetitorTable();
      updateCompetitorOverview();
      updateCompetitiveAnalysis();
      updatePriceAlerts();
      
      alert('âœ… ç«¶å“æ·»åŠ æˆåŠŸï¼');
    }

    function displayCompetitorTable() {
      const tbody = document.getElementById('competitorTableBody');
      
      if (!tbody) return;
      
      if (competitorData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 30px; color: #6c757d;">
              å°šæœªæ·»åŠ ç«¶å“è³‡æ–™
            </td>
          </tr>
        `;
        return;
      }
      
      // æ‡‰ç”¨ç¯©é¸
      const filter = document.getElementById('filterAdvantage')?.value || '';
      let filteredData = [...competitorData];
      
      if (filter === 'advantage') {
        filteredData = filteredData.filter(c => c.priceDiff < 0); // æˆ‘æ–¹æ›´ä¾¿å®œ
      } else if (filter === 'disadvantage') {
        filteredData = filteredData.filter(c => c.priceDiff > 0); // ç«¶å“æ›´ä¾¿å®œ
      } else if (filter === 'warning') {
        filteredData = filteredData.filter(c => c.priceDiff > c.compPrice * 0.1); // è²´è¶…é 10%
      }
      
      tbody.innerHTML = filteredData.map((comp, index) => {
        const isAdvantage = comp.priceDiff < 0;
        const isWarning = comp.priceDiff > comp.compPrice * 0.1;
        
        let competitiveStatus = '';
        let competitiveColor = '';
        
        if (isWarning) {
          competitiveStatus = 'âš ï¸ éœ€é—œæ³¨';
          competitiveColor = '#fbbf24';
        } else if (isAdvantage) {
          competitiveStatus = 'âœ… æœ‰å„ªå‹¢';
          competitiveColor = '#28a745';
        } else {
          competitiveStatus = 'âŒ è¼ƒè²´';
          competitiveColor = '#dc3545';
        }
        
        return `
          <tr style="background: ${isWarning ? '#fef3c7' : 'white'};">
            <td style="padding: 12px; border: 1px solid #e5e7eb;">
              ${comp.myProductCode} ${comp.myProductName}
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">
              <strong>${comp.myPrice} å…ƒ</strong>
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb;">
              ${comp.compName}
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">
              <strong>${comp.compPrice} å…ƒ</strong>
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; color: ${isAdvantage ? '#28a745' : '#dc3545'};">
              <strong>${isAdvantage ? '' : '+'}${comp.priceDiff.toFixed(0)} å…ƒ</strong>
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: right; color: ${isAdvantage ? '#28a745' : '#dc3545'};">
              <strong>${isAdvantage ? '' : '+'}${comp.priceDiffPercent}%</strong>
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">
              <span style="background: ${competitiveColor}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">
                ${competitiveStatus}
              </span>
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">
              ${comp.compUrl ? `<a href="${comp.compUrl}" target="_blank" style="color: #667eea;">ğŸ”— æŸ¥çœ‹</a>` : '-'}
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; text-align: center;">
              <button onclick="deleteCompetitor(${index})" 
                      style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                ğŸ—‘ï¸ åˆªé™¤
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function deleteCompetitor(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç«¶å“è³‡æ–™å—ï¼Ÿ')) {
        competitorData.splice(index, 1);
        displayCompetitorTable();
        updateCompetitorOverview();
        updateCompetitiveAnalysis();
        updatePriceAlerts();
      }
    }

    function filterCompetitorTable() {
      displayCompetitorTable();
    }

    function updateCompetitorOverview() {
      const total = competitorData.length;
      const advantage = competitorData.filter(c => c.priceDiff < 0).length;
      const disadvantage = competitorData.filter(c => c.priceDiff > 0).length;
      
      const avgDiff = total > 0 
        ? (competitorData.reduce((sum, c) => sum + parseFloat(c.priceDiffPercent), 0) / total).toFixed(1)
        : 0;
      
      document.getElementById('competitorCount').textContent = total;
      document.getElementById('advantageCount').textContent = advantage;
      document.getElementById('disadvantageCount').textContent = disadvantage;
      document.getElementById('avgDifference').textContent = avgDiff + '%';
    }

    function updateCompetitiveAnalysis() {
      const analysisDiv = document.getElementById('competitiveAnalysis');
      
      if (!analysisDiv) return;
      
      if (competitorData.length === 0) {
        analysisDiv.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 30px;">æ·»åŠ ç«¶å“å¾Œå³å¯æŸ¥çœ‹åˆ†æ</p>';
        return;
      }
      
      // æŒ‰ç”¢å“åˆ†çµ„
      const productGroups = {};
      competitorData.forEach(comp => {
        const key = comp.myProductName;
        if (!productGroups[key]) {
          productGroups[key] = [];
        }
        productGroups[key].push(comp);
      });
      
      let html = '<div style="display: grid; gap: 15px;">';
      
      Object.entries(productGroups).forEach(([productName, comps]) => {
        const avgPrice = comps.reduce((sum, c) => sum + c.compPrice, 0) / comps.length;
        const myPrice = comps[0].myPrice;
        const diff = myPrice - avgPrice;
        const diffPercent = ((diff / avgPrice) * 100).toFixed(1);
        
        html += `
          <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid ${diff < 0 ? '#28a745' : '#dc3545'};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong style="font-size: 1.1rem;">${productName}</strong><br>
                <span style="color: #6c757d;">ç›£æ§ ${comps.length} å€‹ç«¶å“</span>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 0.9rem; color: #6c757d;">æˆ‘æ–¹: ${myPrice} å…ƒ</div>
                <div style="font-size: 0.9rem; color: #6c757d;">ç«¶å“å‡åƒ¹: ${avgPrice.toFixed(0)} å…ƒ</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: ${diff < 0 ? '#28a745' : '#dc3545'};">
                  ${diff < 0 ? 'âœ…' : 'âŒ'} ${diff < 0 ? '' : '+'}${diffPercent}%
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      analysisDiv.innerHTML = html;
    }

    function updatePriceAlerts() {
      const alertsDiv = document.getElementById('priceAlerts');
      
      if (!alertsDiv) return;
      
      // æ‰¾å‡ºéœ€è¦é—œæ³¨çš„ç«¶å“ï¼ˆæˆ‘æ–¹åƒ¹æ ¼é«˜æ–¼ç«¶å“ 10% ä»¥ä¸Šï¼‰
      const warnings = competitorData.filter(c => c.priceDiff > c.compPrice * 0.1);
      
      if (warnings.length === 0) {
        alertsDiv.innerHTML = `
          <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
            âœ… ç›®å‰æ²’æœ‰éœ€è¦é—œæ³¨çš„åƒ¹æ ¼è­¦ç¤º
          </div>
        `;
        return;
      }
      
      let html = `
        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 15px;">
          <strong>âš ï¸ ç™¼ç¾ ${warnings.length} å€‹éœ€è¦é—œæ³¨çš„ç«¶å“åƒ¹æ ¼</strong>
        </div>
      `;
      
      warnings.forEach(w => {
        html += `
          <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #ffc107;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${w.myProductName}</strong><br>
                <span style="color: #6c757d;">ç«¶å“ï¼š${w.compName}</span>
              </div>
              <div style="text-align: right;">
                <div style="color: #6c757d;">æˆ‘æ–¹: ${w.myPrice} å…ƒ</div>
                <div style="color: #6c757d;">ç«¶å“: ${w.compPrice} å…ƒ</div>
                <div style="font-weight: bold; color: #dc3545;">
                  è²´äº† ${w.priceDiff.toFixed(0)} å…ƒ (+${w.priceDiffPercent}%)
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      alertsDiv.innerHTML = html;
    }

    function loadCompetitorSheet() {
      const sheetsId = localStorage.getItem('sheetsId');
      
      if (!sheetsId) {
        alert('âš ï¸ è«‹å…ˆåœ¨ã€Œè³‡æ–™æ•´åˆã€é é¢è¨­å®š Google Sheetsï¼');
        return;
      }
      
      // æç¤ºç”¨æˆ¶
      const sheetName = prompt('è«‹è¼¸å…¥ç«¶å“å·¥ä½œè¡¨åç¨±ï¼š\nï¼ˆä¾‹å¦‚ï¼šè¦çš®ç«¶å“åƒ¹æ ¼ï¼‰', 'è¦çš®ç«¶å“åƒ¹æ ¼');
      
      if (!sheetName) return;
      
      // è®€å–å·¥ä½œè¡¨
      fetchSheetData(sheetsId, sheetName).then(data => {
        if (data.length === 0) {
          alert('âŒ æœªæ‰¾åˆ°ç«¶å“è³‡æ–™ï¼Œè«‹ç¢ºèªå·¥ä½œè¡¨åç¨±æ˜¯å¦æ­£ç¢ºï¼');
          return;
        }
        
        console.log('ğŸ“¥ è¼‰å…¥ç«¶å“è³‡æ–™:', data);
        
        // è§£æç«¶å“è³‡æ–™ä¸¦æ·»åŠ åˆ°ç³»çµ±
        // å‡è¨­æ ¼å¼ï¼šæˆ‘æ–¹ç”¢å“åç¨±/ç·¨è™Ÿ | ç«¶å“åç¨± | ç«¶å“åƒ¹æ ¼ | ç«¶å“ç¶²å€
        let successCount = 0;
        
        data.forEach(row => {
          // å˜—è©¦åŒ¹é…æˆ‘æ–¹ç”¢å“
          const myProductKey = row['æˆ‘æ–¹ç”¢å“'] || row['ç”¢å“åç¨±'] || row['ç”¢å“ç·¨è™Ÿ'] || '';
          const matchedIndex = allProducts.findIndex(p => 
            (p['å•†å“åç¨±'] || '').includes(myProductKey) || 
            (p['ç”¢å“ç·¨è™Ÿ'] || '').includes(myProductKey)
          );
          
          if (matchedIndex === -1) {
            console.warn('âš ï¸ æ‰¾ä¸åˆ°åŒ¹é…çš„ç”¢å“:', myProductKey);
            return;
          }
          
          const myProduct = allProducts[matchedIndex];
          const myPrice = myProduct['å»ºè­°å”®åƒ¹'] || calculateQuickPrice(myProduct);
          const compName = row['ç«¶å“åç¨±'] || row['ç«¶å“'] || '';
          const compPrice = parseFloat(row['ç«¶å“åƒ¹æ ¼'] || row['åƒ¹æ ¼'] || 0);
          const compUrl = row['ç«¶å“ç¶²å€'] || row['ç¶²å€'] || '';
          
          if (!compName || compPrice <= 0) {
            console.warn('âš ï¸ ç«¶å“è³‡æ–™ä¸å®Œæ•´:', row);
            return;
          }
          
          // æ·»åŠ ç«¶å“
          const priceDiff = myPrice - compPrice;
          const priceDiffPercent = ((priceDiff / compPrice) * 100).toFixed(1);
          
          competitorData.push({
            myProductIndex: matchedIndex,
            myProductName: myProduct['å•†å“åç¨±'] || myProduct['ç”¢å“åç¨±'] || '',
            myProductCode: myProduct['ç”¢å“ç·¨è™Ÿ'] || myProduct['å•†å“ç·¨è™Ÿ'] || '',
            myPrice: Math.ceil(myPrice),
            compName,
            compPrice,
            compUrl,
            priceDiff,
            priceDiffPercent,
            addedDate: new Date().toISOString()
          });
          
          successCount++;
        });
        
        if (successCount > 0) {
          alert(`âœ… æˆåŠŸè¼‰å…¥ ${successCount} ç­†ç«¶å“è³‡æ–™ï¼`);
          displayCompetitorTable();
          updateCompetitorOverview();
          updateCompetitiveAnalysis();
          updatePriceAlerts();
        } else {
          alert('âŒ æ²’æœ‰æˆåŠŸè¼‰å…¥ä»»ä½•ç«¶å“è³‡æ–™ï¼Œè«‹æª¢æŸ¥è³‡æ–™æ ¼å¼ï¼');
        }
      }).catch(error => {
        console.error('âŒ è¼‰å…¥ç«¶å“å·¥ä½œè¡¨å¤±æ•—:', error);
        alert('âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå·¥ä½œè¡¨åç¨±å’Œæ ¼å¼æ˜¯å¦æ­£ç¢ºï¼');
      });
    }

    function exportCompetitorData() {
      if (competitorData.length === 0) {
        alert('æ²’æœ‰ç«¶å“è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼');
        return;
      }
      
      // å»ºç«‹ CSV
      const headers = ['æˆ‘æ–¹ç”¢å“ç·¨è™Ÿ', 'æˆ‘æ–¹ç”¢å“åç¨±', 'æˆ‘æ–¹åƒ¹æ ¼', 'ç«¶å“åç¨±', 'ç«¶å“åƒ¹æ ¼', 'åƒ¹å·®', 'åƒ¹å·®%', 'ç«¶çˆ­åŠ›', 'ç«¶å“ç¶²å€'];
      let csv = headers.join(',') + '\n';
      
      competitorData.forEach(comp => {
        const competitive = comp.priceDiff < 0 ? 'æœ‰å„ªå‹¢' : 
                          comp.priceDiff > comp.compPrice * 0.1 ? 'éœ€é—œæ³¨' : 'è¼ƒè²´';
        
        const row = [
          comp.myProductCode,
          comp.myProductName,
          comp.myPrice,
          comp.compName,
          comp.compPrice,
          comp.priceDiff.toFixed(0),
          comp.priceDiffPercent + '%',
          competitive,
          comp.compUrl || ''
        ].map(val => `"${val}"`);
        
        csv += row.join(',') + '\n';
      });
      
      // ä¸‹è¼‰
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ç«¶å“æ¯”åƒ¹_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }
  </script>
</body>
</html>
