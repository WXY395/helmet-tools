<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>電商定價管理系統</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 10px;
  min-height: 100vh;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  text-align: center;
  margin-bottom: 25px;
}

.header h1 {
  font-size: clamp(1.5rem, 5vw, 2.5rem);
  margin-bottom: 10px;
}

.header p {
  font-size: clamp(0.9rem, 3vw, 1.1rem);
  opacity: 0.95;
}

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-button {
  flex: 1;
  min-width: 150px;
  padding: 12px 20px;
  border: none;
  background: #f8f9fa;
  color: #495057;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.3s;
}

.tab-button:hover {
  background: #e9ecef;
  transform: translateY(-2px);
}

.tab-button.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.cost-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border: 1px solid #e5e7eb;
}

.cost-card h3 {
  color: #2c3e50;
  margin-bottom: 15px;
  font-size: 1.3rem;
}

.input-group {
  margin-bottom: 15px;
}

.input-group label {
  display: block;
  margin-bottom: 5px;
  color: #495057;
  font-weight: 600;
  font-size: 0.95rem;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 10px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: #667eea;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn:active {
  transform: translateY(0);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

table th,
table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
  font-size: 0.9rem;
}

table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
  cursor: pointer;
}

table th:hover {
  background: #e9ecef;
}

table tr:hover {
  background: #f8f9fa;
}

.data-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.overview-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.overview-card .number {
  font-size: 2.5rem;
  font-weight: bold;
  margin: 10px 0;
}

.overview-card .label {
  font-size: 0.9rem;
  opacity: 0.9;
}

.filter-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.product-table {
  overflow-x: auto;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
}

.pagination button {
  padding: 8px 16px;
  border: 1px solid #dee2e6;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
}

.pagination button:hover:not(:disabled) {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

.pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

@keyframes loading {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(400%); }
}

@media (max-width: 768px) {
  .tabs {
    flex-direction: column;
  }
  
  .tab-button {
    min-width: 100%;
  }
  
  .container {
    padding: 15px;
  }
  
  table {
    font-size: 0.8rem;
  }
  
  table th,
  table td {
    padding: 8px;
  }
}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🛍️ 電商定價管理系統</h1>
      <p>整合產品庫 · 智能分析 · 競品監控</p>
    </div>

    <div class="tabs">
      <button class="tab-button active" onclick="showTab('calculator')">💰 訂價計算器</button>
      <button class="tab-button" onclick="showTab('connect')">🔗 資料整合</button>
      <button class="tab-button" onclick="showTab('analysis')">📊 智能分析</button>
      <button class="tab-button" onclick="showTab('competitor')">🎯 競品監控</button>
    </div>

    <!-- 訂價計算器 -->
    <div id="calculator" class="tab-content active">
      <h2>💰 訂價計算器</h2>
      
      <div class="cost-card">
        <h3>📦 產品選擇</h3>
        <div class="input-group">
          <label>從產品庫選擇（選填）</label>
          <select id="productSelector" onchange="loadProductData()">
            <option value="">-- 手動輸入或選擇產品 --</option>
          </select>
        </div>
      </div>
      
      <div class="cost-card">
        <h3>基本設定</h3>
        <div class="input-group">
          <label>進貨單價（元）</label>
          <input type="number" id="cost" value="100" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>訂購數量</label>
          <input type="number" id="quantity" value="1" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>包材成本（元）</label>
          <input type="number" id="packaging" value="10" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>人事時間成本（元）</label>
          <input type="number" id="labor" value="20" oninput="calculate()">
        </div>
      </div>

      <div class="cost-card">
        <h3>蝦皮費率設定</h3>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="isActivity" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">活動期間（手續費 7.5%）</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="hasFreeShipping" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">免運補貼 7%</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="isPreorder" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">預購費用 3%</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="hasCoins" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">蝦幣回饋 3%</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="hasTax" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px; font-weight: 600;">營業稅 5%</span>
          </label>
        </div>
        
        <div id="feeRateSummary" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea;"></div>
      </div>

      <div class="cost-card">
        <h3>目標利潤</h3>
        <div class="input-group">
          <label>目標利潤率（%）</label>
          <input type="number" id="targetMargin" value="30" oninput="calculate()">
        </div>
      </div>

      <div id="result"></div>
    </div>

    <!-- 資料整合 -->
    <div id="connect" class="tab-content">
      <h2>🔗 資料整合</h2>
      
      <div class="cost-card">
        <h3>連接 Google Sheets</h3>
        
        <div class="input-group">
          <label for="sheetsId">📄 Google Sheets 網址</label>
          <input type="text" id="sheetsId" 
                 placeholder="貼上您的 Google Sheets 完整網址">
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b;">
          <p style="margin: 0 0 10px 0; color: #92400e; font-weight: 600;">⚙️ 設定步驟：</p>
          <ol style="margin: 0; padding-left: 20px; color: #78350f; line-height: 1.8;">
            <li>打開您的 Google Sheets</li>
            <li>點擊右上角「共用」按鈕</li>
            <li>選擇「知道連結的任何人」</li>
            <li>權限設為「檢視者」</li>
            <li>複製網址並貼到上方欄位</li>
          </ol>
        </div>
        
        <button class="btn" onclick="loadSheetsList()">🔗 解析試算表</button>
      </div>

      <div id="sheetsList"></div>
      <div id="connectionResult"></div>
    </div>

    <!-- 智能分析 -->
    <div id="analysis" class="tab-content">
      <h2>📊 智能分析</h2>
      
      <div id="analysisOverview" class="data-overview"></div>
      
      <div class="cost-card">
        <h3>🔍 搜尋與篩選</h3>
        <div class="filter-section">
          <div class="input-group">
            <label>搜尋產品</label>
            <input type="text" id="searchProduct" placeholder="輸入產品編號、名稱、規格或顏色" oninput="filterProducts()">
          </div>
          <div class="input-group">
            <label>來源篩選</label>
            <select id="sourceFilter" onchange="filterProducts()">
              <option value="">全部來源</option>
            </select>
          </div>
        </div>
      </div>

      <div class="cost-card">
        <h3>📦 批量定價計算</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div class="input-group">
            <label>包材成本（元）</label>
            <input type="number" id="batchPackaging" value="10">
          </div>
          <div class="input-group">
            <label>人事時間成本（元）</label>
            <input type="number" id="batchLabor" value="20">
          </div>
          <div class="input-group">
            <label>目標利潤率（%）</label>
            <input type="number" id="batchMargin" value="30">
          </div>
        </div>
        <button class="btn" onclick="calculateBatchPricing()">🚀 計算所有產品建議售價</button>
      </div>

      <div class="cost-card">
        <h3>📋 產品清單</h3>
        <div style="margin-bottom: 15px;">
          <label style="cursor: pointer;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <span style="margin-left: 5px; font-weight: 600;">全選當前頁面</span>
          </label>
          <button class="btn" onclick="exportSelectedProducts()" style="margin-left: 15px; padding: 8px 16px; font-size: 0.9rem;">
            📥 匯出選中產品
          </button>
        </div>
        
        <div class="product-table">
          <table id="productTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll()"></th>
                <th onclick="sortTable('prodId')">產品編號 ▼</th>
                <th onclick="sortTable('name')">商品名稱 ▼</th>
                <th onclick="sortTable('spec')">規格 ▼</th>
                <th onclick="sortTable('color')">顏色 ▼</th>
                <th onclick="sortTable('cost')">單價 ▼</th>
                <th>建議售價</th>
                <th>預估利潤</th>
                <th>狀態</th>
                <th>來源</th>
              </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
          </table>
        </div>
        
        <div class="pagination" id="pagination"></div>
      </div>

      <div class="cost-card">
        <h3>📈 價格分析</h3>
        <div id="priceAnalysis"></div>
      </div>
    </div>

    <!-- 競品監控 -->
    <div id="competitor" class="tab-content">
      <h2>🎯 競品監控</h2>
      
      <div class="cost-card" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">
        <h3 style="color: #2d3748;">📊 競品監控概覽</h3>
        <div class="data-overview">
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="competitorCount">0</div>
            <div style="color: #6c757d;">監控產品數</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="advantageCount">0</div>
            <div style="color: #6c757d;">價格優勢</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #dc3545;" id="disadvantageCount">0</div>
            <div style="color: #6c757d;">價格劣勢</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #f093fb;" id="avgDifference">0%</div>
            <div style="color: #6c757d;">平均價差</div>
          </div>
        </div>
      </div>

      <div class="cost-card">
        <h3>➕ 添加競品資料</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div class="input-group">
            <label>選擇我方產品</label>
            <select id="myProductSelect">
              <option value="">-- 請選擇 --</option>
            </select>
          </div>
          <div class="input-group">
            <label>競品名稱</label>
            <input type="text" id="compName" placeholder="例如: XX品牌安全帽">
          </div>
          <div class="input-group">
            <label>競品售價</label>
            <input type="number" id="compPrice" placeholder="例如: 450">
          </div>
          <div class="input-group">
            <label>競品網址（選填）</label>
            <input type="text" id="compUrl" placeholder="https://...">
          </div>
        </div>
        
        <button class="btn" onclick="addCompetitor()">➕ 添加競品</button>
      </div>

      <div class="cost-card">
        <h3>📋 競品比價表</h3>
        <div style="margin-bottom: 15px;">
          <label>篩選：</label>
          <select id="competitorFilter" onchange="filterCompetitorTable()" style="padding: 8px; border-radius: 6px; border: 2px solid #e5e7eb;">
            <option value="all">全部</option>
            <option value="advantage">僅價格優勢</option>
            <option value="disadvantage">僅價格劣勢</option>
            <option value="warning">需要關注</option>
          </select>
          <button class="btn" onclick="exportCompetitorData()" style="margin-left: 15px; padding: 8px 16px; font-size: 0.9rem;">
            📥 匯出競品數據
          </button>
        </div>
        
        <div style="overflow-x: auto;">
          <table id="competitorTable">
            <thead>
              <tr>
                <th>我方產品編號</th>
                <th>我方產品名稱</th>
                <th>我方售價</th>
                <th>競品名稱</th>
                <th>競品售價</th>
                <th>價差</th>
                <th>價差%</th>
                <th>競爭力</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="competitorTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="cost-card">
        <h3>📊 競爭力分析</h3>
        <div id="competitiveAnalysis"></div>
      </div>

      <div class="cost-card">
        <h3>⚠️ 價格警示</h3>
        <div id="priceAlerts"></div>
      </div>
    </div>

    <script>
    // 全域變數
    let allSheets = [];
    let sheetsData = {};
    let currentSpreadsheetId = '';
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let sortColumn = '';
    let sortDirection = 'asc';
    let competitorData = [];

    // 安全取得元素
    function safeGetElement(id) {
      const element = document.getElementById(id);
      if (!element) console.warn(`⚠️ 找不到元素: ${id}`);
      return element;
    }

    function safeGetValue(id, defaultValue = 0) {
      const element = safeGetElement(id);
      if (!element) return defaultValue;
      return element.type === 'checkbox' ? element.checked : element.value;
    }

    // 費率更新與計算
    function updateFeeRateDisplay() {
      try {
        const isActivity = safeGetValue('isActivity', false);
        const hasFreeShipping = safeGetValue('hasFreeShipping', false);
        const isPreorder = safeGetValue('isPreorder', false);
        const hasCoins = safeGetValue('hasCoins', false);
        const hasTax = safeGetValue('hasTax', false);

        let totalFee = 0;
        let feeDetails = [];

        const baseFee = isActivity ? 7.5 : 5.5;
        totalFee += baseFee;
        feeDetails.push(`手續費: ${baseFee}%`);

        totalFee += 2;
        feeDetails.push('金流費: 2%');

        if (hasFreeShipping) {
          totalFee += 7;
          feeDetails.push('免運補貼: 7%');
        }
        if (isPreorder) {
          totalFee += 3;
          feeDetails.push('預購費用: 3%');
        }
        if (hasCoins) {
          totalFee += 3;
          feeDetails.push('蝦幣回饋: 3%');
        }
        if (hasTax) {
          totalFee += 5;
          feeDetails.push('營業稅: 5%');
        }

        const summaryElement = safeGetElement('feeRateSummary');
        if (summaryElement) {
          summaryElement.innerHTML = `
            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">
              📊 總費率: ${totalFee.toFixed(1)}%
            </div>
            <div style="font-size: 0.9rem; color: #6c757d; line-height: 1.6;">
              ${feeDetails.join(' + ')}
            </div>
          `;
        }

        calculate();
      } catch (error) {
        console.error('❌ 更新費率顯示時發生錯誤:', error);
      }
    }

    function calculate() {
      try {
        const cost = parseFloat(safeGetValue('cost', 0)) || 0;
        const quantity = parseInt(safeGetValue('quantity', 1)) || 1;
        const packaging = parseFloat(safeGetValue('packaging', 0)) || 0;
        const labor = parseFloat(safeGetValue('labor', 0)) || 0;
        const targetMargin = parseFloat(safeGetValue('targetMargin', 30)) || 30;

        const productCost = cost * quantity;
        const totalCost = productCost + packaging + labor;

        const isActivity = safeGetValue('isActivity', false);
        const hasFreeShipping = safeGetValue('hasFreeShipping', false);
        const isPreorder = safeGetValue('isPreorder', false);
        const hasCoins = safeGetValue('hasCoins', false);
        const hasTax = safeGetValue('hasTax', false);

        let totalFeeRate = isActivity ? 7.5 : 5.5;
        totalFeeRate += 2;
        if (hasFreeShipping) totalFeeRate += 7;
        if (isPreorder) totalFeeRate += 3;
        if (hasCoins) totalFeeRate += 3;
        if (hasTax) totalFeeRate += 5;

        const suggestedPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
        const netIncome = suggestedPrice * (1 - totalFeeRate / 100);
        const grossProfit = netIncome - totalCost;

        const resultElement = safeGetElement('result');
        if (resultElement) {
          resultElement.innerHTML = `
            <div class="cost-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <h3 style="color: white; margin-bottom: 20px;">💰 計算結果</h3>
              
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">總成本</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${totalCost.toFixed(0)}</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">建議售價</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${suggestedPrice.toFixed(0)}</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">預估淨收</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${netIncome.toFixed(0)}</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">毛利潤</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${grossProfit.toFixed(0)}</div>
                </div>
              </div>

              <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 0.95rem; line-height: 1.8;">
                <strong>💡 計算說明:</strong><br>
                • 商品成本: $${cost} × ${quantity} = $${productCost.toFixed(0)}<br>
                • 總成本: $${productCost.toFixed(0)} + $${packaging} + $${labor} = $${totalCost.toFixed(0)}<br>
                • 總費率: ${totalFeeRate.toFixed(1)}%<br>
                • 目標利潤率: ${targetMargin}%<br>
                • 淨收 = 售價 × (1 - ${totalFeeRate.toFixed(1)}%) = $${netIncome.toFixed(0)}<br>
                • 毛利 = 淨收 - 成本 = $${grossProfit.toFixed(0)}
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('❌ 計算時發生錯誤:', error);
      }
    }

    // Google Sheets 整合
    function loadSheetsList() {
      try {
        const input = safeGetElement('sheetsId');
        if (!input) return;
        
        const inputValue = input.value.trim();
        
        if (!inputValue) {
          alert('⚠️ 請輸入 Google Sheets 網址');
          return;
        }

        const match = inputValue.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (!match) {
          alert('❌ 無效的 Google Sheets 網址格式');
          return;
        }

        currentSpreadsheetId = match[1];
        console.log('✅ 解析成功 Sheets ID:', currentSpreadsheetId);

        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = `
            <div class="cost-card">
              <h3>🔄 正在準備讀取...</h3>
              <p>請稍候</p>
            </div>
          `;
        }

        setTimeout(() => {
          fetchSheetNames();
        }, 300);
        
      } catch (error) {
        console.error('❌ 載入工作表列表時發生錯誤:', error);
        alert('發生錯誤，請重試');
      }
    }

    function fetchSheetNames() {
      try {
        const testUrl = `https://docs.google.com/spreadsheets/d/${currentSpreadsheetId}/edit`;
        
        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = `
            <div class="cost-card" style="background: #fff3cd;">
              <h3 style="color: #856404;">📋 手動輸入工作表名稱</h3>
              <p style="color: #856404; margin-bottom: 15px;">
                請到您的 <a href="${testUrl}" target="_blank" style="color: #0066cc;">Google Sheets</a> 左下角查看工作表標籤名稱
              </p>
              <div id="sheetInputs"></div>
              <button class="btn" onclick="addSheetInput()" style="background: #4caf50;">
                ➕ 新增工作表
              </button>
              <button class="btn" onclick="saveAndLoadSheets()" style="background: #667eea; margin-left: 10px;">
                💾 保存並讀取數據
              </button>
            </div>
          `;
        }
        
        for (let i = 0; i < 3; i++) {
          addSheetInput();
        }
        
      } catch (error) {
        console.error('❌ 顯示輸入界面時發生錯誤:', error);
      }
    }

    function addSheetInput() {
      try {
        const container = safeGetElement('sheetInputs');
        if (!container) return;
        
        const index = container.children.length + 1;
        
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `
          <label>工作表 ${index}</label>
          <input type="text" class="sheet-name-input" placeholder="例如: EVO_產品庫" />
        `;
        container.appendChild(div);
      } catch (error) {
        console.error('❌ 新增輸入框時發生錯誤:', error);
      }
    }

    async function saveAndLoadSheets() {
      try {
        const inputs = document.querySelectorAll('.sheet-name-input');
        allSheets = Array.from(inputs)
          .map(input => input.value.trim())
          .filter(name => name);

        if (allSheets.length === 0) {
          alert('⚠️ 請至少輸入一個工作表名稱');
          return;
        }

        console.log('📝 工作表名稱:', allSheets);

        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = `
            <div class="cost-card">
              <h3>🔄 正在讀取數據...</h3>
              <p>請稍候，正在從 Google Sheets 讀取資料</p>
              <div style="margin-top: 15px;">
                <div class="loading-bar" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                  <div style="width: 30%; height: 100%; background: #667eea; animation: loading 1.5s infinite;"></div>
                </div>
              </div>
            </div>
          `;
        }

        const config = {
          spreadsheetId: currentSpreadsheetId,
          sheets: allSheets,
          savedAt: new Date().toISOString()
        };
        localStorage.setItem(`sheets_config_${currentSpreadsheetId}`, JSON.stringify(config));

        await fetchAllSheetsData();
        
      } catch (error) {
        console.error('❌ 保存並載入工作表時發生錯誤:', error);
        alert('發生錯誤，請重試');
      }
    }

    async function fetchAllSheetsData() {
      sheetsData = {};
      allProducts = [];
      let successCount = 0;
      let failCount = 0;

      for (const sheetName of allSheets) {
        try {
          console.log(`📥 正在讀取: ${sheetName}`);
          
          const encodedSheetName = encodeURIComponent(sheetName);
          const csvUrl = `https://docs.google.com/spreadsheets/d/${currentSpreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodedSheetName}`;
          
          const response = await fetch(csvUrl);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const csvText = await response.text();
          const parsedData = parseCSV(csvText);
          
          sheetsData[sheetName] = parsedData;
          
          // 整合到 allProducts
          parsedData.forEach(row => {
            allProducts.push({
              prodId: row['產品編號'] || row['商品編號'] || row['編號'] || '',
              name: row['商品名稱'] || row['產品名稱'] || row['名稱'] || '',
              spec: row['規格'] || row['尺寸'] || '',
              color: row['顏色'] || row['色系'] || '',
              cost: parseFloat(row['單價'] || row['進貨價'] || row['成本'] || 0),
              source: sheetName
            });
          });
          
          successCount++;
          console.log(`✅ ${sheetName}: ${parsedData.length} 筆資料`);
          
        } catch (error) {
          console.error(`❌ ${sheetName} 讀取失敗:`, error);
          failCount++;
          sheetsData[sheetName] = [];
        }
      }

      displayLoadResults(successCount, failCount);
      updateProductSelector();
      updateAnalysisPage();
      updateCompetitorPage();
    }

    function parseCSV(csvText) {
      try {
        const lines = csvText.split('\n').filter(line => line.trim());
        if (lines.length === 0) return [];
        
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          data.push(row);
        }
        
        return data;
      } catch (error) {
        console.error('❌ 解析 CSV 時發生錯誤:', error);
        return [];
      }
    }

    function displayLoadResults(successCount, failCount) {
      try {
        let html = `
          <div class="cost-card" style="background: ${successCount > 0 ? '#e8f5e9' : '#ffebee'};">
            <h3 style="color: ${successCount > 0 ? '#2e7d32' : '#c62828'};">
              ${successCount > 0 ? '✅' : '❌'} 數據載入完成
            </h3>
            <p>成功: <strong>${successCount}</strong> 個工作表 | 失敗: <strong>${failCount}</strong> 個</p>
        `;

        html += '<div style="margin-top: 15px;">';
        for (const sheetName of allSheets) {
          const data = sheetsData[sheetName] || [];
          const icon = data.length > 0 ? '✅' : '❌';
          const color = data.length > 0 ? '#2e7d32' : '#c62828';
          
          html += `
            <div style="padding: 10px; margin: 8px 0; background: white; border-radius: 8px; border-left: 4px solid ${color};">
              <strong>${icon} ${sheetName}</strong>: ${data.length} 筆資料
            </div>
          `;
        }
        html += '</div>';

        if (successCount > 0) {
          html += `
            <button class="btn" onclick="showDataPreview()" style="margin-top: 15px; background: #667eea;">
              👁️ 預覽已載入的數據
            </button>
          `;
        }

        html += '</div>';
        
        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = html;
        }
      } catch (error) {
        console.error('❌ 顯示載入結果時發生錯誤:', error);
      }
    }

    function showDataPreview() {
      try {
        let html = '<div class="cost-card"><h3>📊 數據預覽</h3>';
        
        for (const sheetName in sheetsData) {
          const data = sheetsData[sheetName];
          if (data.length === 0) continue;
          
          html += `
            <h4 style="margin-top: 20px; color: #667eea;">📋 ${sheetName} (共 ${data.length} 筆)</h4>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem;">
                <thead>
                  <tr style="background: #f8f9fa;">
          `;
          
          const headers = Object.keys(data[0]);
          headers.forEach(header => {
            html += `<th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">${header}</th>`;
          });
          html += '</tr></thead><tbody>';
          
          const previewData = data.slice(0, 5);
          previewData.forEach(row => {
            html += '<tr>';
            headers.forEach(header => {
              html += `<td style="padding: 8px; border: 1px solid #dee2e6;">${row[header]}</td>`;
            });
            html += '</tr>';
          });
          
          html += '</tbody></table>';
          
          if (data.length > 5) {
            html += `<p style="color: #6c757d; margin-top: 5px; font-size: 0.85rem;">... 還有 ${data.length - 5} 筆資料</p>`;
          }
          
          html += '</div>';
        }
        
        html += `
          <button class="btn" onclick="hideDataPreview()" style="margin-top: 20px; background: #6c757d;">
            ◀️ 返回
          </button>
        </div>`;
        
        const resultElement = safeGetElement('connectionResult');
        if (resultElement) {
          resultElement.innerHTML = html;
        }
      } catch (error) {
        console.error('❌ 顯示數據預覽時發生錯誤:', error);
      }
    }

    function hideDataPreview() {
      const resultElement = safeGetElement('connectionResult');
      if (resultElement) {
        resultElement.innerHTML = '';
      }
    }

    // 更新產品選擇器
    function updateProductSelector() {
      const selector = safeGetElement('productSelector');
      const myProductSelect = safeGetElement('myProductSelect');
      
      if (!selector) return;
      
      selector.innerHTML = '<option value="">-- 手動輸入或選擇產品 --</option>';
      
      if (myProductSelect) {
        myProductSelect.innerHTML = '<option value="">-- 請選擇 --</option>';
      }
      
      allProducts.forEach((product, index) => {
        const displayName = `${product.prodId || 'N/A'} - ${product.name} (${product.spec} ${product.color}) - $${product.cost}`;
        selector.innerHTML += `<option value="${index}">${displayName}</option>`;
        
        if (myProductSelect) {
          myProductSelect.innerHTML += `<option value="${index}">${displayName}</option>`;
        }
      });
    }

    function loadProductData() {
      const selector = safeGetElement('productSelector');
      if (!selector) return;
      
      const selectedIndex = selector.value;
      if (selectedIndex === '') return;
      
      const product = allProducts[selectedIndex];
      if (!product) return;
      
      const costInput = safeGetElement('cost');
      if (costInput) costInput.value = product.cost;
      
      calculate();
    }

    // 智能分析頁面
    function updateAnalysisPage() {
      filteredProducts = [...allProducts];
      updateOverview();
      updateSourceFilter();
      renderProductTable();
      updatePriceAnalysis();
    }

    function updateOverview() {
      const overview = safeGetElement('analysisOverview');
      if (!overview) return;
      
      const totalProducts = allProducts.length;
      const sources = [...new Set(allProducts.map(p => p.source))];
      const avgCost = totalProducts > 0 
        ? allProducts.reduce((sum, p) => sum + p.cost, 0) / totalProducts 
        : 0;
      const costs = allProducts.map(p => p.cost).filter(c => c > 0);
      const minCost = costs.length > 0 ? Math.min(...costs) : 0;
      const maxCost = costs.length > 0 ? Math.max(...costs) : 0;
      
      overview.innerHTML = `
        <div class="overview-card">
          <div class="label">總產品數</div>
          <div class="number">${totalProducts}</div>
        </div>
        <div class="overview-card">
          <div class="label">產品庫數量</div>
          <div class="number">${sources.length}</div>
        </div>
        <div class="overview-card">
          <div class="label">平均成本</div>
          <div class="number">$${avgCost.toFixed(0)}</div>
        </div>
        <div class="overview-card">
          <div class="label">成本範圍</div>
          <div class="number" style="font-size: 1.5rem;">$${minCost}-${maxCost}</div>
        </div>
      `;
    }

    function updateSourceFilter() {
      const filter = safeGetElement('sourceFilter');
      if (!filter) return;
      
      const sources = [...new Set(allProducts.map(p => p.source))];
      filter.innerHTML = '<option value="">全部來源</option>';
      sources.forEach(source => {
        filter.innerHTML += `<option value="${source}">${source}</option>`;
      });
    }

    function filterProducts() {
      const searchTerm = safeGetValue('searchProduct', '').toLowerCase();
      const sourceFilter = safeGetValue('sourceFilter', '');
      
      filteredProducts = allProducts.filter(product => {
        const matchSearch = !searchTerm || 
          product.prodId.toLowerCase().includes(searchTerm) ||
          product.name.toLowerCase().includes(searchTerm) ||
          product.spec.toLowerCase().includes(searchTerm) ||
          product.color.toLowerCase().includes(searchTerm);
          
        const matchSource = !sourceFilter || product.source === sourceFilter;
        
        return matchSearch && matchSource;
      });
      
      currentPage = 1;
      renderProductTable();
    }

    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      filteredProducts.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        if (column === 'cost') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        }
        
        if (sortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });
      
      renderProductTable();
    }

    function renderProductTable() {
      const tbody = safeGetElement('productTableBody');
      if (!tbody) return;
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      tbody.innerHTML = '';
      
      pageProducts.forEach((product, index) => {
        const globalIndex = start + index;
        const row = tbody.insertRow();
        
        row.innerHTML = `
          <td><input type="checkbox" class="product-checkbox" data-index="${globalIndex}"></td>
          <td>${product.prodId || 'N/A'}</td>
          <td>${product.name || 'N/A'}</td>
          <td>${product.spec || '-'}</td>
          <td>${product.color || '-'}</td>
          <td>$${product.cost.toFixed(0)}</td>
          <td id="suggested-${globalIndex}">-</td>
          <td id="profit-${globalIndex}">-</td>
          <td>-</td>
          <td>${product.source}</td>
        `;
      });
      
      updatePagination();
    }

    function updatePagination() {
      const pagination = safeGetElement('pagination');
      if (!pagination) return;
      
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      
      pagination.innerHTML = `
        <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>◀️ 上一頁</button>
        <span>第 ${currentPage} / ${totalPages} 頁</span>
        <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>下一頁 ▶️</button>
      `;
    }

    function changePage(delta) {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
      renderProductTable();
    }

    function toggleSelectAll() {
      const selectAll = safeGetElement('selectAll');
      const checkboxes = document.querySelectorAll('.product-checkbox');
      
      if (selectAll) {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
      }
    }

    function calculateBatchPricing() {
      const packaging = parseFloat(safeGetValue('batchPackaging', 10)) || 10;
      const labor = parseFloat(safeGetValue('batchLabor', 20)) || 20;
      const targetMargin = parseFloat(safeGetValue('batchMargin', 30)) || 30;
      
      const totalFeeRate = 5.5 + 2; // 基本手續費 + 金流費
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      pageProducts.forEach((product, index) => {
        const globalIndex = start + index;
        const totalCost = product.cost + packaging + labor;
        const suggestedPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
        const netIncome = suggestedPrice * (1 - totalFeeRate / 100);
        const profit = netIncome - totalCost;
        
        const suggestedEl = document.getElementById(`suggested-${globalIndex}`);
        const profitEl = document.getElementById(`profit-${globalIndex}`);
        
        if (suggestedEl) {
          suggestedEl.textContent = `$${suggestedPrice.toFixed(0)}`;
          suggestedEl.style.fontWeight = 'bold';
          suggestedEl.style.color = '#667eea';
        }
        
        if (profitEl) {
          profitEl.textContent = `$${profit.toFixed(0)}`;
          profitEl.style.fontWeight = 'bold';
          profitEl.style.color = profit >= 0 ? '#28a745' : '#dc3545';
        }
      });
    }

    function exportSelectedProducts() {
      const checkboxes = document.querySelectorAll('.product-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('⚠️ 請至少選擇一個產品');
        return;
      }
      
      let csv = '產品編號,商品名稱,規格,顏色,成本,來源\n';
      
      checkboxes.forEach(cb => {
        const index = parseInt(cb.dataset.index);
        const product = filteredProducts[index];
        const row = [
          product.prodId,
          product.name,
          product.spec,
          product.color,
          product.cost,
          product.source
        ].map(val => `"${val}"`);
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `產品清單_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function updatePriceAnalysis() {
      const analysis = safeGetElement('priceAnalysis');
      if (!analysis) return;
      
      const costs = allProducts.map(p => p.cost).filter(c => c > 0);
      if (costs.length === 0) {
        analysis.innerHTML = '<p>暫無數據</p>';
        return;
      }
      
      const ranges = [
        { label: '$0-100', min: 0, max: 100 },
        { label: '$100-300', min: 100, max: 300 },
        { label: '$300-500', min: 300, max: 500 },
        { label: '$500-1000', min: 500, max: 1000 },
        { label: '$1000+', min: 1000, max: Infinity }
      ];
      
      let html = '<div style="display: grid; gap: 10px;">';
      
      ranges.forEach(range => {
        const count = costs.filter(c => c >= range.min && c < range.max).length;
        const percentage = ((count / costs.length) * 100).toFixed(1);
        
        html += `
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 100px; font-weight: 600;">${range.label}</div>
            <div style="flex: 1; background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
              <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                ${count > 0 ? `${count} (${percentage}%)` : ''}
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      analysis.innerHTML = html;
    }

    // 競品監控
    function updateCompetitorPage() {
      updateCompetitorOverview();
      displayCompetitorTable();
      updateCompetitiveAnalysis();
      updatePriceAlerts();
    }

    function addCompetitor() {
      const myProductIndex = safeGetValue('myProductSelect', '');
      const compName = safeGetValue('compName', '');
      const compPrice = parseFloat(safeGetValue('compPrice', 0)) || 0;
      const compUrl = safeGetValue('compUrl', '');
      
      if (myProductIndex === '' || !compName || compPrice === 0) {
        alert('⚠️ 請完整填寫資料');
        return;
      }
      
      const myProduct = allProducts[parseInt(myProductIndex)];
      if (!myProduct) return;
      
      // 簡單計算我方售價（使用基本費率）
      const totalFeeRate = 7.5;
      const targetMargin = 30;
      const totalCost = myProduct.cost + 10 + 20;
      const myPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
      
      const priceDiff = myPrice - compPrice;
      const priceDiffPercent = ((priceDiff / compPrice) * 100).toFixed(1);
      
      competitorData.push({
        myProductCode: myProduct.prodId,
        myProductName: myProduct.name,
        myPrice: myPrice,
        compName: compName,
        compPrice: compPrice,
        compUrl: compUrl,
        priceDiff: priceDiff,
        priceDiffPercent: priceDiffPercent
      });
      
      // 清空輸入
      const compNameInput = safeGetElement('compName');
      const compPriceInput = safeGetElement('compPrice');
      const compUrlInput = safeGetElement('compUrl');
      if (compNameInput) compNameInput.value = '';
      if (compPriceInput) compPriceInput.value = '';
      if (compUrlInput) compUrlInput.value = '';
      
      updateCompetitorPage();
    }

    function displayCompetitorTable() {
      const tbody = safeGetElement('competitorTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      const filter = safeGetValue('competitorFilter', 'all');
      
      let filteredData = competitorData;
      
      if (filter === 'advantage') {
        filteredData = competitorData.filter(c => c.priceDiff < 0);
      } else if (filter === 'disadvantage') {
        filteredData = competitorData.filter(c => c.priceDiff > 0);
      } else if (filter === 'warning') {
        filteredData = competitorData.filter(c => c.priceDiff > c.compPrice * 0.1);
      }
      
      filteredData.forEach((comp, index) => {
        const row = tbody.insertRow();
        
        const competitive = comp.priceDiff < 0 ? '✅ 有優勢' : 
                          comp.priceDiff > comp.compPrice * 0.1 ? '⚠️ 需關注' : '❌ 較貴';
        
        const diffColor = comp.priceDiff < 0 ? '#28a745' : '#dc3545';
        
        row.innerHTML = `
          <td>${comp.myProductCode}</td>
          <td>${comp.myProductName}</td>
          <td>$${comp.myPrice.toFixed(0)}</td>
          <td>${comp.compName}</td>
          <td>$${comp.compPrice}</td>
          <td style="color: ${diffColor}; font-weight: bold;">$${comp.priceDiff.toFixed(0)}</td>
          <td style="color: ${diffColor}; font-weight: bold;">${comp.priceDiffPercent}%</td>
          <td>${competitive}</td>
          <td><button class="btn" onclick="deleteCompetitor(${index})" style="padding: 5px 10px; font-size: 0.85rem; background: #dc3545;">🗑️</button></td>
        `;
      });
    }

    function deleteCompetitor(index) {
      if (confirm('確定要刪除這個競品資料嗎？')) {
        competitorData.splice(index, 1);
        updateCompetitorPage();
      }
    }

    function filterCompetitorTable() {
      displayCompetitorTable();
    }

    function updateCompetitorOverview() {
      const totalCount = competitorData.length;
      const advantageCount = competitorData.filter(c => c.priceDiff < 0).length;
      const disadvantageCount = competitorData.filter(c => c.priceDiff > 0).length;
      
      const avgDiff = totalCount > 0 
        ? competitorData.reduce((sum, c) => sum + parseFloat(c.priceDiffPercent), 0) / totalCount 
        : 0;
      
      const countEl = safeGetElement('competitorCount');
      const advantageEl = safeGetElement('advantageCount');
      const disadvantageEl = safeGetElement('disadvantageCount');
      const avgDiffEl = safeGetElement('avgDifference');
      
      if (countEl) countEl.textContent = totalCount;
      if (advantageEl) advantageEl.textContent = advantageCount;
      if (disadvantageEl) disadvantageEl.textContent = disadvantageCount;
      if (avgDiffEl) avgDiffEl.textContent = `${avgDiff.toFixed(1)}%`;
    }

    function updateCompetitiveAnalysis() {
      const analysis = safeGetElement('competitiveAnalysis');
      if (!analysis) return;
      
      if (competitorData.length === 0) {
        analysis.innerHTML = '<p style="color: #6c757d;">暫無競品數據</p>';
        return;
      }
      
      const byProduct = {};
      competitorData.forEach(comp => {
        if (!byProduct[comp.myProductCode]) {
          byProduct[comp.myProductCode] = {
            name: comp.myProductName,
            myPrice: comp.myPrice,
            competitors: []
          };
        }
        byProduct[comp.myProductCode].competitors.push(comp);
      });
      
      let html = '';
      
      for (const code in byProduct) {
        const product = byProduct[code];
        const avgCompPrice = product.competitors.reduce((sum, c) => sum + c.compPrice, 0) / product.competitors.length;
        const priceDiff = product.myPrice - avgCompPrice;
        const diffColor = priceDiff < 0 ? '#28a745' : '#dc3545';
        
        html += `
          <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="color: #2c3e50; margin-bottom: 10px;">${code} - ${product.name}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">我方售價</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">$${product.myPrice.toFixed(0)}</div>
              </div>
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">競品平均價</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: #764ba2;">$${avgCompPrice.toFixed(0)}</div>
              </div>
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">價格差異</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: ${diffColor};">$${priceDiff.toFixed(0)}</div>
              </div>
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">競品數量</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: #6c757d;">${product.competitors.length}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      analysis.innerHTML = html;
    }

    function updatePriceAlerts() {
      const alerts = safeGetElement('priceAlerts');
      if (!alerts) return;
      
      const warnings = competitorData.filter(c => c.priceDiff > c.compPrice * 0.1);
      
      if (warnings.length === 0) {
        alerts.innerHTML = '<p style="color: #28a745;">✅ 目前無需要關注的產品</p>';
        return;
      }
      
      let html = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">';
      html += `<p style="color: #856404; font-weight: 600; margin-bottom: 10px;">⚠️ 發現 ${warnings.length} 個產品價格需要關注：</p>`;
      html += '<ul style="margin: 0; padding-left: 20px; color: #856404;">';
      
      warnings.forEach(comp => {
        html += `
          <li style="margin: 5px 0;">
            <strong>${comp.myProductName}</strong>：我方 $${comp.myPrice.toFixed(0)} vs 競品 $${comp.compPrice}（貴了 $${comp.priceDiff.toFixed(0)}，${comp.priceDiffPercent}%）
          </li>
        `;
      });
      
      html += '</ul></div>';
      alerts.innerHTML = html;
    }

    function exportCompetitorData() {
      if (competitorData.length === 0) {
        alert('⚠️ 暫無競品數據可匯出');
        return;
      }
      
      let csv = '我方產品編號,我方產品名稱,我方售價,競品名稱,競品售價,價差,價差%,競爭力,競品網址\n';
      
      competitorData.forEach(comp => {
        const competitive = comp.priceDiff < 0 ? '有優勢' : 
                          comp.priceDiff > comp.compPrice * 0.1 ? '需關注' : '較貴';
        
        const row = [
          comp.myProductCode,
          comp.myProductName,
          comp.myPrice.toFixed(0),
          comp.compName,
          comp.compPrice,
          comp.priceDiff.toFixed(0),
          comp.priceDiffPercent + '%',
          competitive,
          comp.compUrl || ''
        ].map(val => `"${val}"`);
        
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `競品比價_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // 頁面切換
    function showTab(tabName) {
      try {
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => content.classList.remove('active'));

        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(btn => btn.classList.remove('active'));

        const targetContent = document.getElementById(tabName);
        if (targetContent) {
          targetContent.classList.add('active');
        }
        
        if (event && event.target) {
          event.target.classList.add('active');
        }

        // 切換到智能分析時自動更新
        if (tabName === 'analysis' && allProducts.length > 0) {
          setTimeout(() => {
            updateAnalysisPage();
          }, 100);
        }
        
        // 切換到競品監控時自動更新
        if (tabName === 'competitor' && allProducts.length > 0) {
          setTimeout(() => {
            updateCompetitorPage();
          }, 100);
        }
        
      } catch (error) {
        console.error('❌ 切換頁籤時發生錯誤:', error);
      }
    }

    // 初始化
    window.onload = function() {
      try {
        console.log('✅ 頁面載入完成');
        
        setTimeout(() => {
          updateFeeRateDisplay();
          console.log('✅ 初始化完成');
        }, 100);
        
      } catch (error) {
        console.error('❌ 初始化時發生錯誤:', error);
      }
    };
    </script>
  </div>
</body>
</html>
