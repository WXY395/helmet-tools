async function loadSheetsList() {
  console.log('âœ… loadSheetsList å‡½æ•¸è¢«å‘¼å«');
  
  const sheetsUrl = document.getElementById('sheetsId').value;
  
  if (!sheetsUrl) {
    alert('âš ï¸ è«‹å…ˆè¼¸å…¥ Google Sheets å®Œæ•´ç¶²å€ï¼\n\nç¯„ä¾‹ï¼šhttps://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit');
    return;
  }
  
  // å¾ç¶²å€æå– Sheets ID
  const match = sheetsUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if (!match) {
    alert('âš ï¸ ç¶²å€æ ¼å¼ä¸æ­£ç¢ºï¼\n\nè«‹ç¢ºèªæ‚¨è¤‡è£½äº†å®Œæ•´çš„ Google Sheets ç¶²å€');
    return;
  }
  
  const sheetsId = match[1];
  console.log('âœ… Sheets ID:', sheetsId);
  
  // ä¿å­˜ç¶²å€
  localStorage.setItem('sheetsUrl', sheetsUrl);
  localStorage.setItem('sheetsId', sheetsId);
  
  // é¡¯ç¤ºè¼‰å…¥ä¸­
  document.getElementById('connectionResult').innerHTML = `
    <div class="ai-suggestion" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <p style="color: white; margin: 0;">â³ æ­£åœ¨è§£æè©¦ç®—è¡¨...</p>
    </div>
  `;
  
  // æç¤ºç”¨æˆ¶æ‰‹å‹•è¼¸å…¥å·¥ä½œè¡¨åç¨±
  promptForSheetNames(sheetsId);
}

function promptForSheetNames(sheetsId) {
  document.getElementById('connectionResult').innerHTML = `
    <div class="cost-card" style="margin-top: 20px;">
      <h3 style="color: #2563eb; margin-bottom: 15px;">ğŸ“ è«‹è¼¸å…¥æ‚¨çš„å·¥ä½œè¡¨åç¨±</h3>
      
      <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <p style="margin: 0 0 10px 0; color: #92400e; font-weight: 600;">ğŸ’¡ å¦‚ä½•æ‰¾åˆ°å·¥ä½œè¡¨åç¨±ï¼Ÿ</p>
        <ol style="margin: 0; padding-left: 20px; color: #78350f;">
          <li>æ‰“é–‹æ‚¨çš„ Google Sheets</li>
          <li>çœ‹<strong>å·¦ä¸‹è§’</strong>çš„æ¨™ç±¤åç¨±</li>
          <li>é€å€‹è¼¸å…¥åˆ°ä¸‹æ–¹æ¬„ä½ä¸­</li>
        </ol>
      </div>
      
      <div id="sheetNameInputs">
        <div class="input-group" style="margin-bottom: 10px;">
          <label>å·¥ä½œè¡¨ 1ï¼š</label>
          <input type="text" id="sheetName1" placeholder="ä¾‹å¦‚ï¼šæ™ºåŒ_ç”¢å“åº«" 
                 style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
        <div class="input-group" style="margin-bottom: 10px;">
          <label>å·¥ä½œè¡¨ 2ï¼š</label>
          <input type="text" id="sheetName2" placeholder="ä¾‹å¦‚ï¼šæ—­ç…Œ_ç”¢å“åº«" 
                 style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn" onclick="addMoreSheetInput()" 
                style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
          â• æ–°å¢æ›´å¤šå·¥ä½œè¡¨
        </button>
        <button class="btn" onclick="saveAndLoadSheets()" 
                style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
          ğŸ’¾ ä¿å­˜ä¸¦è¼‰å…¥å·¥ä½œè¡¨
        </button>
      </div>
    </div>
  `;
}

let sheetInputCount = 2;

function addMoreSheetInput() {
  sheetInputCount++;
  const container = document.getElementById('sheetNameInputs');
  const newInput = document.createElement('div');
  newInput.className = 'input-group';
  newInput.style = 'margin-bottom: 10px;';
  newInput.innerHTML = `
    <label>å·¥ä½œè¡¨ ${sheetInputCount}ï¼š</label>
    <input type="text" id="sheetName${sheetInputCount}" placeholder="è¼¸å…¥å·¥ä½œè¡¨åç¨±" 
           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
  `;
  container.appendChild(newInput);
}

async function saveAndLoadSheets() {
  const sheetsId = localStorage.getItem('sheetsId');
  const sheetNames = [];
  
  // æ”¶é›†æ‰€æœ‰è¼¸å…¥çš„å·¥ä½œè¡¨åç¨±
  for (let i = 1; i <= sheetInputCount; i++) {
    const input = document.getElementById(`sheetName${i}`);
    if (input && input.value.trim()) {
      sheetNames.push(input.value.trim());
    }
  }
  
  if (sheetNames.length === 0) {
    alert('âš ï¸ è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹å·¥ä½œè¡¨åç¨±ï¼');
    return;
  }
  
  console.log('âœ… ä¿å­˜çš„å·¥ä½œè¡¨åç¨±:', sheetNames);
  
  // ä¿å­˜å·¥ä½œè¡¨åç¨±
  localStorage.setItem('userSheetNames', JSON.stringify(sheetNames));
  
  // é¡¯ç¤ºè¼‰å…¥ä¸­
  document.getElementById('connectionResult').innerHTML = `
    <div class="ai-suggestion" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <p style="color: white; margin: 0;">â³ æ­£åœ¨è®€å– ${sheetNames.length} å€‹å·¥ä½œè¡¨çš„æ•¸æ“š...</p>
    </div>
  `;
  
  // å˜—è©¦è®€å–æ¯å€‹å·¥ä½œè¡¨çš„æ•¸æ“š
  availableSheets = [];
  
  for (const sheetName of sheetNames) {
    try {
      const data = await fetchSheetData(sheetsId, sheetName);
      availableSheets.push({
        name: sheetName,
        type: 'product',
        count: data.length,
        desc: `åŒ…å« ${data.length} ç­†è³‡æ–™`,
        data: data
      });
      console.log(`âœ… ${sheetName}: ${data.length} ç­†è³‡æ–™`);
    } catch (error) {
      console.error(`âŒ ç„¡æ³•è®€å– ${sheetName}:`, error);
      availableSheets.push({
        name: sheetName,
        type: 'product',
        count: 0,
        desc: 'è®€å–å¤±æ•—',
        data: []
      });
    }
  }
  
  displaySheetsList();
  
  console.log('âœ… å·¥ä½œè¡¨æ¸…å–®å·²é¡¯ç¤ºï¼Œå…±', availableSheets.length, 'å€‹å·¥ä½œè¡¨');
}

async function fetchSheetData(sheetsId, sheetName) {
  // æ–¹æ³• 1: å˜—è©¦ä½¿ç”¨å…¬é–‹çš„ CSV å°å‡ºï¼ˆéœ€è¦çŸ¥é“ gidï¼‰
  // æ–¹æ³• 2: ä½¿ç”¨ Google Sheets ç™¼å¸ƒç‚ºç¶²é åŠŸèƒ½
  // æ–¹æ³• 3: ç›®å‰å…ˆä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼Œç­‰ç”¨æˆ¶ç¢ºèªå¾Œå†å¯¦ä½œçœŸå¯¦è®€å–
  
  console.log(`ğŸ“¥ å˜—è©¦è®€å–å·¥ä½œè¡¨: ${sheetName}`);
  
  // æš«æ™‚è¿”å›æ¨¡æ“¬æ•¸æ“šï¼ˆä¸‹ä¸€æ­¥æœƒå¯¦ä½œçœŸå¯¦è®€å–ï¼‰
  return new Promise((resolve) => {
    setTimeout(() => {
      // æ¨¡æ“¬ä¸€äº›ç”¢å“æ•¸æ“š
      const mockData = [
        { å•†å“åç¨±: 'å•†å“A', é€²è²¨å–®åƒ¹: 100, è¦æ ¼: 'L', é¡è‰²: 'é»‘è‰²' },
        { å•†å“åç¨±: 'å•†å“B', é€²è²¨å–®åƒ¹: 150, è¦æ ¼: 'M', é¡è‰²: 'ç™½è‰²' }
      ];
      resolve(mockData);
    }, 500);
  });
}
