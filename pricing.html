<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›»å•†å®šåƒ¹ç®¡ç†ç³»çµ±</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 10px;
  min-height: 100vh;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  text-align: center;
  margin-bottom: 25px;
}

.header h1 {
  font-size: clamp(1.5rem, 5vw, 2.5rem);
  margin-bottom: 10px;
}

.header p {
  font-size: clamp(0.9rem, 3vw, 1.1rem);
  opacity: 0.95;
}

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.tab-button {
  flex: 1;
  min-width: 150px;
  padding: 12px 20px;
  border: none;
  background: #f8f9fa;
  color: #495057;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.3s;
}

.tab-button:hover {
  background: #e9ecef;
  transform: translateY(-2px);
}

.tab-button.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.cost-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border: 1px solid #e5e7eb;
}

.cost-card h3 {
  color: #2c3e50;
  margin-bottom: 15px;
  font-size: 1.3rem;
}

.input-group {
  margin-bottom: 15px;
}

.input-group label {
  display: block;
  margin-bottom: 5px;
  color: #495057;
  font-weight: 600;
  font-size: 0.95rem;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 10px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: #667eea;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn:active {
  transform: translateY(0);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

table th,
table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
  font-size: 0.9rem;
}

table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
  cursor: pointer;
}

table th:hover {
  background: #e9ecef;
}

table tr:hover {
  background: #f8f9fa;
}

.data-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.overview-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.overview-card .number {
  font-size: 2.5rem;
  font-weight: bold;
  margin: 10px 0;
}

.overview-card .label {
  font-size: 0.9rem;
  opacity: 0.9;
}

.filter-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.product-table {
  overflow-x: auto;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
}

.pagination button {
  padding: 8px 16px;
  border: 1px solid #dee2e6;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
}

.pagination button:hover:not(:disabled) {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

.pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

@keyframes loading {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(400%); }
}

@media (max-width: 768px) {
  .tabs {
    flex-direction: column;
  }
  
  .tab-button {
    min-width: 100%;
  }
  
  .container {
    padding: 15px;
  }
  
  table {
    font-size: 0.8rem;
  }
  
  table th,
  table td {
    padding: 8px;
  }
}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ›ï¸ é›»å•†å®šåƒ¹ç®¡ç†ç³»çµ±</h1>
      <p>æ•´åˆç”¢å“åº« Â· æ™ºèƒ½åˆ†æ Â· ç«¶å“ç›£æ§</p>
    </div>

    <div class="tabs">
      <button class="tab-button active" onclick="showTab('calculator')">ğŸ’° è¨‚åƒ¹è¨ˆç®—å™¨</button>
      <button class="tab-button" onclick="showTab('connect')">ğŸ”— è³‡æ–™æ•´åˆ</button>
      <button class="tab-button" onclick="showTab('analysis')">ğŸ“Š æ™ºèƒ½åˆ†æ</button>
      <button class="tab-button" onclick="showTab('competitor')">ğŸ¯ ç«¶å“ç›£æ§</button>
    </div>

    <!-- è¨‚åƒ¹è¨ˆç®—å™¨ -->
    <div id="calculator" class="tab-content active">
      <h2>ğŸ’° è¨‚åƒ¹è¨ˆç®—å™¨</h2>
      
      <div class="cost-card">
        <h3>ğŸ“¦ ç”¢å“é¸æ“‡</h3>
        <div class="input-group">
          <label>å¾ç”¢å“åº«é¸æ“‡ï¼ˆé¸å¡«ï¼‰</label>
          <select id="productSelector" onchange="loadProductData()">
            <option value="">-- æ‰‹å‹•è¼¸å…¥æˆ–é¸æ“‡ç”¢å“ --</option>
          </select>
        </div>
      </div>
      
      <div class="cost-card">
        <h3>åŸºæœ¬è¨­å®š</h3>
        <div class="input-group">
          <label>é€²è²¨å–®åƒ¹ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="cost" value="100" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>è¨‚è³¼æ•¸é‡</label>
          <input type="number" id="quantity" value="1" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>åŒ…ææˆæœ¬ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="packaging" value="10" oninput="calculate()">
        </div>
        <div class="input-group">
          <label>äººäº‹æ™‚é–“æˆæœ¬ï¼ˆå…ƒï¼‰</label>
          <input type="number" id="labor" value="20" oninput="calculate()">
        </div>
      </div>

      <div class="cost-card">
        <h3>è¦çš®è²»ç‡è¨­å®š</h3>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="isActivity" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">æ´»å‹•æœŸé–“ï¼ˆæ‰‹çºŒè²» 7.5%ï¼‰</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="hasFreeShipping" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">å…é‹è£œè²¼ 7%</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="isPreorder" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">é è³¼è²»ç”¨ 3%</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="hasCoins" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px;">è¦å¹£å›é¥‹ 3%</span>
          </label>
        </div>
        <div class="input-group">
          <label style="cursor: pointer;">
            <input type="checkbox" id="hasTax" onchange="updateFeeRateDisplay(); calculate()">
            <span style="margin-left: 5px; font-weight: 600;">ç‡Ÿæ¥­ç¨… 5%</span>
          </label>
        </div>
        
        <div id="feeRateSummary" style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea;"></div>
      </div>

      <div class="cost-card">
        <h3>ç›®æ¨™åˆ©æ½¤</h3>
        <div class="input-group">
          <label>ç›®æ¨™åˆ©æ½¤ç‡ï¼ˆ%ï¼‰</label>
          <input type="number" id="targetMargin" value="30" oninput="calculate()">
        </div>
      </div>

      <div id="result"></div>
    </div>

    <!-- è³‡æ–™æ•´åˆ -->
    <div id="connect" class="tab-content">
      <h2>ğŸ”— è³‡æ–™æ•´åˆ</h2>
      
      <div class="cost-card">
        <h3>é€£æ¥ Google Sheets</h3>
        
        <div class="input-group">
          <label for="sheetsId">ğŸ“„ Google Sheets ç¶²å€</label>
          <input type="text" id="sheetsId" 
                 placeholder="è²¼ä¸Šæ‚¨çš„ Google Sheets å®Œæ•´ç¶²å€">
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f59e0b;">
          <p style="margin: 0 0 10px 0; color: #92400e; font-weight: 600;">âš™ï¸ è¨­å®šæ­¥é©Ÿï¼š</p>
          <ol style="margin: 0; padding-left: 20px; color: #78350f; line-height: 1.8;">
            <li>æ‰“é–‹æ‚¨çš„ Google Sheets</li>
            <li>é»æ“Šå³ä¸Šè§’ã€Œå…±ç”¨ã€æŒ‰éˆ•</li>
            <li>é¸æ“‡ã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººã€</li>
            <li>æ¬Šé™è¨­ç‚ºã€Œæª¢è¦–è€…ã€</li>
            <li>è¤‡è£½ç¶²å€ä¸¦è²¼åˆ°ä¸Šæ–¹æ¬„ä½</li>
          </ol>
        </div>
        
        <button class="btn" onclick="loadSheetsList()">ğŸ”— è§£æè©¦ç®—è¡¨</button>
      </div>

      <div id="sheetsList"></div>
      <div id="connectionResult"></div>
    </div>

    <!-- æ™ºèƒ½åˆ†æ -->
    <div id="analysis" class="tab-content">
      <h2>ğŸ“Š æ™ºèƒ½åˆ†æ</h2>
      
      <div id="analysisOverview" class="data-overview"></div>
      
      <div class="cost-card">
        <h3>ğŸ” æœå°‹èˆ‡ç¯©é¸</h3>
        <div class="filter-section">
          <div class="input-group">
            <label>æœå°‹ç”¢å“</label>
            <input type="text" id="searchProduct" placeholder="è¼¸å…¥ç”¢å“ç·¨è™Ÿã€åç¨±ã€è¦æ ¼æˆ–é¡è‰²" oninput="filterProducts()">
          </div>
          <div class="input-group">
            <label>ä¾†æºç¯©é¸</label>
            <select id="sourceFilter" onchange="filterProducts()">
              <option value="">å…¨éƒ¨ä¾†æº</option>
            </select>
          </div>
        </div>
      </div>

      <div class="cost-card">
        <h3>ğŸ“¦ æ‰¹é‡å®šåƒ¹è¨ˆç®—</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div class="input-group">
            <label>åŒ…ææˆæœ¬ï¼ˆå…ƒï¼‰</label>
            <input type="number" id="batchPackaging" value="10">
          </div>
          <div class="input-group">
            <label>äººäº‹æ™‚é–“æˆæœ¬ï¼ˆå…ƒï¼‰</label>
            <input type="number" id="batchLabor" value="20">
          </div>
          <div class="input-group">
            <label>ç›®æ¨™åˆ©æ½¤ç‡ï¼ˆ%ï¼‰</label>
            <input type="number" id="batchMargin" value="30">
          </div>
        </div>
        <button class="btn" onclick="calculateBatchPricing()">ğŸš€ è¨ˆç®—æ‰€æœ‰ç”¢å“å»ºè­°å”®åƒ¹</button>
      </div>

      <div class="cost-card">
        <h3>ğŸ“‹ ç”¢å“æ¸…å–®</h3>
        <div style="margin-bottom: 15px;">
          <label style="cursor: pointer;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <span style="margin-left: 5px; font-weight: 600;">å…¨é¸ç•¶å‰é é¢</span>
          </label>
          <button class="btn" onclick="exportSelectedProducts()" style="margin-left: 15px; padding: 8px 16px; font-size: 0.9rem;">
            ğŸ“¥ åŒ¯å‡ºé¸ä¸­ç”¢å“
          </button>
        </div>
        
        <div class="product-table">
          <table id="productTable">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll()"></th>
                <th onclick="sortTable('prodId')">ç”¢å“ç·¨è™Ÿ â–¼</th>
                <th onclick="sortTable('name')">å•†å“åç¨± â–¼</th>
                <th onclick="sortTable('spec')">è¦æ ¼ â–¼</th>
                <th onclick="sortTable('color')">é¡è‰² â–¼</th>
                <th onclick="sortTable('cost')">å–®åƒ¹ â–¼</th>
                <th>å»ºè­°å”®åƒ¹</th>
                <th>é ä¼°åˆ©æ½¤</th>
                <th>ç‹€æ…‹</th>
                <th>ä¾†æº</th>
              </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
          </table>
        </div>
        
        <div class="pagination" id="pagination"></div>
      </div>

      <div class="cost-card">
        <h3>ğŸ“ˆ åƒ¹æ ¼åˆ†æ</h3>
        <div id="priceAnalysis"></div>
      </div>
    </div>

    <!-- ç«¶å“ç›£æ§ -->
    <div id="competitor" class="tab-content">
      <h2>ğŸ¯ ç«¶å“ç›£æ§</h2>
      
      <div class="cost-card" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">
        <h3 style="color: #2d3748;">ğŸ“Š ç«¶å“ç›£æ§æ¦‚è¦½</h3>
        <div class="data-overview">
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="competitorCount">0</div>
            <div style="color: #6c757d;">ç›£æ§ç”¢å“æ•¸</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="advantageCount">0</div>
            <div style="color: #6c757d;">åƒ¹æ ¼å„ªå‹¢</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #dc3545;" id="disadvantageCount">0</div>
            <div style="color: #6c757d;">åƒ¹æ ¼åŠ£å‹¢</div>
          </div>
          <div style="background: white; padding: 15px; border-radius: 10px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: bold; color: #f093fb;" id="avgDifference">0%</div>
            <div style="color: #6c757d;">å¹³å‡åƒ¹å·®</div>
          </div>
        </div>
      </div>

      <div class="cost-card">
        <h3>â• æ·»åŠ ç«¶å“è³‡æ–™</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div class="input-group">
            <label>é¸æ“‡æˆ‘æ–¹ç”¢å“</label>
            <select id="myProductSelect">
              <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
          </div>
          <div class="input-group">
            <label>ç«¶å“åç¨±</label>
            <input type="text" id="compName" placeholder="ä¾‹å¦‚: XXå“ç‰Œå®‰å…¨å¸½">
          </div>
          <div class="input-group">
            <label>ç«¶å“å”®åƒ¹</label>
            <input type="number" id="compPrice" placeholder="ä¾‹å¦‚: 450">
          </div>
          <div class="input-group">
            <label>ç«¶å“ç¶²å€ï¼ˆé¸å¡«ï¼‰</label>
            <input type="text" id="compUrl" placeholder="https://...">
          </div>
        </div>
        
        <button class="btn" onclick="addCompetitor()">â• æ·»åŠ ç«¶å“</button>
      </div>

      <div class="cost-card">
        <h3>ğŸ“‹ ç«¶å“æ¯”åƒ¹è¡¨</h3>
        <div style="margin-bottom: 15px;">
          <label>ç¯©é¸ï¼š</label>
          <select id="competitorFilter" onchange="filterCompetitorTable()" style="padding: 8px; border-radius: 6px; border: 2px solid #e5e7eb;">
            <option value="all">å…¨éƒ¨</option>
            <option value="advantage">åƒ…åƒ¹æ ¼å„ªå‹¢</option>
            <option value="disadvantage">åƒ…åƒ¹æ ¼åŠ£å‹¢</option>
            <option value="warning">éœ€è¦é—œæ³¨</option>
          </select>
          <button class="btn" onclick="exportCompetitorData()" style="margin-left: 15px; padding: 8px 16px; font-size: 0.9rem;">
            ğŸ“¥ åŒ¯å‡ºç«¶å“æ•¸æ“š
          </button>
        </div>
        
        <div style="overflow-x: auto;">
          <table id="competitorTable">
            <thead>
              <tr>
                <th>æˆ‘æ–¹ç”¢å“ç·¨è™Ÿ</th>
                <th>æˆ‘æ–¹ç”¢å“åç¨±</th>
                <th>æˆ‘æ–¹å”®åƒ¹</th>
                <th>ç«¶å“åç¨±</th>
                <th>ç«¶å“å”®åƒ¹</th>
                <th>åƒ¹å·®</th>
                <th>åƒ¹å·®%</th>
                <th>ç«¶çˆ­åŠ›</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="competitorTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="cost-card">
        <h3>ğŸ“Š ç«¶çˆ­åŠ›åˆ†æ</h3>
        <div id="competitiveAnalysis"></div>
      </div>

      <div class="cost-card">
        <h3>âš ï¸ åƒ¹æ ¼è­¦ç¤º</h3>
        <div id="priceAlerts"></div>
      </div>
    </div>

    <script>
    // å…¨åŸŸè®Šæ•¸
    let allSheets = [];
    let sheetsData = {};
    let currentSpreadsheetId = '';
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let sortColumn = '';
    let sortDirection = 'asc';
    let competitorData = [];

    // å®‰å…¨å–å¾—å…ƒç´ 
    function safeGetElement(id) {
      const element = document.getElementById(id);
      if (!element) console.warn(`âš ï¸ æ‰¾ä¸åˆ°å…ƒç´ : ${id}`);
      return element;
    }

    function safeGetValue(id, defaultValue = 0) {
      const element = safeGetElement(id);
      if (!element) return defaultValue;
      return element.type === 'checkbox' ? element.checked : element.value;
    }

    // è²»ç‡æ›´æ–°èˆ‡è¨ˆç®—
    function updateFeeRateDisplay() {
      try {
        const isActivity = safeGetValue('isActivity', false);
        const hasFreeShipping = safeGetValue('hasFreeShipping', false);
        const isPreorder = safeGetValue('isPreorder', false);
        const hasCoins = safeGetValue('hasCoins', false);
        const hasTax = safeGetValue('hasTax', false);

        let totalFee = 0;
        let feeDetails = [];

        const baseFee = isActivity ? 7.5 : 5.5;
        totalFee += baseFee;
        feeDetails.push(`æ‰‹çºŒè²»: ${baseFee}%`);

        totalFee += 2;
        feeDetails.push('é‡‘æµè²»: 2%');

        if (hasFreeShipping) {
          totalFee += 7;
          feeDetails.push('å…é‹è£œè²¼: 7%');
        }
        if (isPreorder) {
          totalFee += 3;
          feeDetails.push('é è³¼è²»ç”¨: 3%');
        }
        if (hasCoins) {
          totalFee += 3;
          feeDetails.push('è¦å¹£å›é¥‹: 3%');
        }
        if (hasTax) {
          totalFee += 5;
          feeDetails.push('ç‡Ÿæ¥­ç¨…: 5%');
        }

        const summaryElement = safeGetElement('feeRateSummary');
        if (summaryElement) {
          summaryElement.innerHTML = `
            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">
              ğŸ“Š ç¸½è²»ç‡: ${totalFee.toFixed(1)}%
            </div>
            <div style="font-size: 0.9rem; color: #6c757d; line-height: 1.6;">
              ${feeDetails.join(' + ')}
            </div>
          `;
        }

        calculate();
      } catch (error) {
        console.error('âŒ æ›´æ–°è²»ç‡é¡¯ç¤ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    function calculate() {
      try {
        const cost = parseFloat(safeGetValue('cost', 0)) || 0;
        const quantity = parseInt(safeGetValue('quantity', 1)) || 1;
        const packaging = parseFloat(safeGetValue('packaging', 0)) || 0;
        const labor = parseFloat(safeGetValue('labor', 0)) || 0;
        const targetMargin = parseFloat(safeGetValue('targetMargin', 30)) || 30;

        const productCost = cost * quantity;
        const totalCost = productCost + packaging + labor;

        const isActivity = safeGetValue('isActivity', false);
        const hasFreeShipping = safeGetValue('hasFreeShipping', false);
        const isPreorder = safeGetValue('isPreorder', false);
        const hasCoins = safeGetValue('hasCoins', false);
        const hasTax = safeGetValue('hasTax', false);

        let totalFeeRate = isActivity ? 7.5 : 5.5;
        totalFeeRate += 2;
        if (hasFreeShipping) totalFeeRate += 7;
        if (isPreorder) totalFeeRate += 3;
        if (hasCoins) totalFeeRate += 3;
        if (hasTax) totalFeeRate += 5;

        const suggestedPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
        const netIncome = suggestedPrice * (1 - totalFeeRate / 100);
        const grossProfit = netIncome - totalCost;

        const resultElement = safeGetElement('result');
        if (resultElement) {
          resultElement.innerHTML = `
            <div class="cost-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <h3 style="color: white; margin-bottom: 20px;">ğŸ’° è¨ˆç®—çµæœ</h3>
              
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">ç¸½æˆæœ¬</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${totalCost.toFixed(0)}</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">å»ºè­°å”®åƒ¹</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${suggestedPrice.toFixed(0)}</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">é ä¼°æ·¨æ”¶</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${netIncome.toFixed(0)}</div>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                  <div style="font-size: 0.9rem; opacity: 0.9;">æ¯›åˆ©æ½¤</div>
                  <div style="font-size: 1.8rem; font-weight: bold; margin-top: 5px;">$${grossProfit.toFixed(0)}</div>
                </div>
              </div>

              <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 0.95rem; line-height: 1.8;">
                <strong>ğŸ’¡ è¨ˆç®—èªªæ˜:</strong><br>
                â€¢ å•†å“æˆæœ¬: $${cost} Ã— ${quantity} = $${productCost.toFixed(0)}<br>
                â€¢ ç¸½æˆæœ¬: $${productCost.toFixed(0)} + $${packaging} + $${labor} = $${totalCost.toFixed(0)}<br>
                â€¢ ç¸½è²»ç‡: ${totalFeeRate.toFixed(1)}%<br>
                â€¢ ç›®æ¨™åˆ©æ½¤ç‡: ${targetMargin}%<br>
                â€¢ æ·¨æ”¶ = å”®åƒ¹ Ã— (1 - ${totalFeeRate.toFixed(1)}%) = $${netIncome.toFixed(0)}<br>
                â€¢ æ¯›åˆ© = æ·¨æ”¶ - æˆæœ¬ = $${grossProfit.toFixed(0)}
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('âŒ è¨ˆç®—æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    // Google Sheets æ•´åˆ
    function loadSheetsList() {
      try {
        const input = safeGetElement('sheetsId');
        if (!input) return;
        
        const inputValue = input.value.trim();
        
        if (!inputValue) {
          alert('âš ï¸ è«‹è¼¸å…¥ Google Sheets ç¶²å€');
          return;
        }

        const match = inputValue.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (!match) {
          alert('âŒ ç„¡æ•ˆçš„ Google Sheets ç¶²å€æ ¼å¼');
          return;
        }

        currentSpreadsheetId = match[1];
        console.log('âœ… è§£ææˆåŠŸ Sheets ID:', currentSpreadsheetId);

        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = `
            <div class="cost-card">
              <h3>ğŸ”„ æ­£åœ¨æº–å‚™è®€å–...</h3>
              <p>è«‹ç¨å€™</p>
            </div>
          `;
        }

        setTimeout(() => {
          fetchSheetNames();
        }, 300);
        
      } catch (error) {
        console.error('âŒ è¼‰å…¥å·¥ä½œè¡¨åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
      }
    }

    function fetchSheetNames() {
      try {
        const testUrl = `https://docs.google.com/spreadsheets/d/${currentSpreadsheetId}/edit`;
        
        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = `
            <div class="cost-card" style="background: #fff3cd;">
              <h3 style="color: #856404;">ğŸ“‹ æ‰‹å‹•è¼¸å…¥å·¥ä½œè¡¨åç¨±</h3>
              <p style="color: #856404; margin-bottom: 15px;">
                è«‹åˆ°æ‚¨çš„ <a href="${testUrl}" target="_blank" style="color: #0066cc;">Google Sheets</a> å·¦ä¸‹è§’æŸ¥çœ‹å·¥ä½œè¡¨æ¨™ç±¤åç¨±
              </p>
              <div id="sheetInputs"></div>
              <button class="btn" onclick="addSheetInput()" style="background: #4caf50;">
                â• æ–°å¢å·¥ä½œè¡¨
              </button>
              <button class="btn" onclick="saveAndLoadSheets()" style="background: #667eea; margin-left: 10px;">
                ğŸ’¾ ä¿å­˜ä¸¦è®€å–æ•¸æ“š
              </button>
            </div>
          `;
        }
        
        for (let i = 0; i < 3; i++) {
          addSheetInput();
        }
        
      } catch (error) {
        console.error('âŒ é¡¯ç¤ºè¼¸å…¥ç•Œé¢æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    function addSheetInput() {
      try {
        const container = safeGetElement('sheetInputs');
        if (!container) return;
        
        const index = container.children.length + 1;
        
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `
          <label>å·¥ä½œè¡¨ ${index}</label>
          <input type="text" class="sheet-name-input" placeholder="ä¾‹å¦‚: EVO_ç”¢å“åº«" />
        `;
        container.appendChild(div);
      } catch (error) {
        console.error('âŒ æ–°å¢è¼¸å…¥æ¡†æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    async function saveAndLoadSheets() {
      try {
        const inputs = document.querySelectorAll('.sheet-name-input');
        allSheets = Array.from(inputs)
          .map(input => input.value.trim())
          .filter(name => name);

        if (allSheets.length === 0) {
          alert('âš ï¸ è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹å·¥ä½œè¡¨åç¨±');
          return;
        }

        console.log('ğŸ“ å·¥ä½œè¡¨åç¨±:', allSheets);

        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = `
            <div class="cost-card">
              <h3>ğŸ”„ æ­£åœ¨è®€å–æ•¸æ“š...</h3>
              <p>è«‹ç¨å€™ï¼Œæ­£åœ¨å¾ Google Sheets è®€å–è³‡æ–™</p>
              <div style="margin-top: 15px;">
                <div class="loading-bar" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                  <div style="width: 30%; height: 100%; background: #667eea; animation: loading 1.5s infinite;"></div>
                </div>
              </div>
            </div>
          `;
        }

        const config = {
          spreadsheetId: currentSpreadsheetId,
          sheets: allSheets,
          savedAt: new Date().toISOString()
        };
        localStorage.setItem(`sheets_config_${currentSpreadsheetId}`, JSON.stringify(config));

        await fetchAllSheetsData();
        
      } catch (error) {
        console.error('âŒ ä¿å­˜ä¸¦è¼‰å…¥å·¥ä½œè¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
      }
    }

    async function fetchAllSheetsData() {
      sheetsData = {};
      allProducts = [];
      let successCount = 0;
      let failCount = 0;

      for (const sheetName of allSheets) {
        try {
          console.log(`ğŸ“¥ æ­£åœ¨è®€å–: ${sheetName}`);
          
          const encodedSheetName = encodeURIComponent(sheetName);
          const csvUrl = `https://docs.google.com/spreadsheets/d/${currentSpreadsheetId}/gviz/tq?tqx=out:csv&sheet=${encodedSheetName}`;
          
          const response = await fetch(csvUrl);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const csvText = await response.text();
          const parsedData = parseCSV(csvText);
          
          sheetsData[sheetName] = parsedData;
          
          // æ•´åˆåˆ° allProducts
          parsedData.forEach(row => {
            allProducts.push({
              prodId: row['ç”¢å“ç·¨è™Ÿ'] || row['å•†å“ç·¨è™Ÿ'] || row['ç·¨è™Ÿ'] || '',
              name: row['å•†å“åç¨±'] || row['ç”¢å“åç¨±'] || row['åç¨±'] || '',
              spec: row['è¦æ ¼'] || row['å°ºå¯¸'] || '',
              color: row['é¡è‰²'] || row['è‰²ç³»'] || '',
              cost: parseFloat(row['å–®åƒ¹'] || row['é€²è²¨åƒ¹'] || row['æˆæœ¬'] || 0),
              source: sheetName
            });
          });
          
          successCount++;
          console.log(`âœ… ${sheetName}: ${parsedData.length} ç­†è³‡æ–™`);
          
        } catch (error) {
          console.error(`âŒ ${sheetName} è®€å–å¤±æ•—:`, error);
          failCount++;
          sheetsData[sheetName] = [];
        }
      }

      displayLoadResults(successCount, failCount);
      updateProductSelector();
      updateAnalysisPage();
      updateCompetitorPage();
    }

    function parseCSV(csvText) {
      try {
        const lines = csvText.split('\n').filter(line => line.trim());
        if (lines.length === 0) return [];
        
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          data.push(row);
        }
        
        return data;
      } catch (error) {
        console.error('âŒ è§£æ CSV æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        return [];
      }
    }

    function displayLoadResults(successCount, failCount) {
      try {
        let html = `
          <div class="cost-card" style="background: ${successCount > 0 ? '#e8f5e9' : '#ffebee'};">
            <h3 style="color: ${successCount > 0 ? '#2e7d32' : '#c62828'};">
              ${successCount > 0 ? 'âœ…' : 'âŒ'} æ•¸æ“šè¼‰å…¥å®Œæˆ
            </h3>
            <p>æˆåŠŸ: <strong>${successCount}</strong> å€‹å·¥ä½œè¡¨ | å¤±æ•—: <strong>${failCount}</strong> å€‹</p>
        `;

        html += '<div style="margin-top: 15px;">';
        for (const sheetName of allSheets) {
          const data = sheetsData[sheetName] || [];
          const icon = data.length > 0 ? 'âœ…' : 'âŒ';
          const color = data.length > 0 ? '#2e7d32' : '#c62828';
          
          html += `
            <div style="padding: 10px; margin: 8px 0; background: white; border-radius: 8px; border-left: 4px solid ${color};">
              <strong>${icon} ${sheetName}</strong>: ${data.length} ç­†è³‡æ–™
            </div>
          `;
        }
        html += '</div>';

        if (successCount > 0) {
          html += `
            <button class="btn" onclick="showDataPreview()" style="margin-top: 15px; background: #667eea;">
              ğŸ‘ï¸ é è¦½å·²è¼‰å…¥çš„æ•¸æ“š
            </button>
          `;
        }

        html += '</div>';
        
        const sheetsListElement = safeGetElement('sheetsList');
        if (sheetsListElement) {
          sheetsListElement.innerHTML = html;
        }
      } catch (error) {
        console.error('âŒ é¡¯ç¤ºè¼‰å…¥çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    function showDataPreview() {
      try {
        let html = '<div class="cost-card"><h3>ğŸ“Š æ•¸æ“šé è¦½</h3>';
        
        for (const sheetName in sheetsData) {
          const data = sheetsData[sheetName];
          if (data.length === 0) continue;
          
          html += `
            <h4 style="margin-top: 20px; color: #667eea;">ğŸ“‹ ${sheetName} (å…± ${data.length} ç­†)</h4>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem;">
                <thead>
                  <tr style="background: #f8f9fa;">
          `;
          
          const headers = Object.keys(data[0]);
          headers.forEach(header => {
            html += `<th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">${header}</th>`;
          });
          html += '</tr></thead><tbody>';
          
          const previewData = data.slice(0, 5);
          previewData.forEach(row => {
            html += '<tr>';
            headers.forEach(header => {
              html += `<td style="padding: 8px; border: 1px solid #dee2e6;">${row[header]}</td>`;
            });
            html += '</tr>';
          });
          
          html += '</tbody></table>';
          
          if (data.length > 5) {
            html += `<p style="color: #6c757d; margin-top: 5px; font-size: 0.85rem;">... é‚„æœ‰ ${data.length - 5} ç­†è³‡æ–™</p>`;
          }
          
          html += '</div>';
        }
        
        html += `
          <button class="btn" onclick="hideDataPreview()" style="margin-top: 20px; background: #6c757d;">
            â—€ï¸ è¿”å›
          </button>
        </div>`;
        
        const resultElement = safeGetElement('connectionResult');
        if (resultElement) {
          resultElement.innerHTML = html;
        }
      } catch (error) {
        console.error('âŒ é¡¯ç¤ºæ•¸æ“šé è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    function hideDataPreview() {
      const resultElement = safeGetElement('connectionResult');
      if (resultElement) {
        resultElement.innerHTML = '';
      }
    }

    // æ›´æ–°ç”¢å“é¸æ“‡å™¨
    function updateProductSelector() {
      const selector = safeGetElement('productSelector');
      const myProductSelect = safeGetElement('myProductSelect');
      
      if (!selector) return;
      
      selector.innerHTML = '<option value="">-- æ‰‹å‹•è¼¸å…¥æˆ–é¸æ“‡ç”¢å“ --</option>';
      
      if (myProductSelect) {
        myProductSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
      }
      
      allProducts.forEach((product, index) => {
        const displayName = `${product.prodId || 'N/A'} - ${product.name} (${product.spec} ${product.color}) - $${product.cost}`;
        selector.innerHTML += `<option value="${index}">${displayName}</option>`;
        
        if (myProductSelect) {
          myProductSelect.innerHTML += `<option value="${index}">${displayName}</option>`;
        }
      });
    }

    function loadProductData() {
      const selector = safeGetElement('productSelector');
      if (!selector) return;
      
      const selectedIndex = selector.value;
      if (selectedIndex === '') return;
      
      const product = allProducts[selectedIndex];
      if (!product) return;
      
      const costInput = safeGetElement('cost');
      if (costInput) costInput.value = product.cost;
      
      calculate();
    }

    // æ™ºèƒ½åˆ†æé é¢
    function updateAnalysisPage() {
      filteredProducts = [...allProducts];
      updateOverview();
      updateSourceFilter();
      renderProductTable();
      updatePriceAnalysis();
    }

    function updateOverview() {
      const overview = safeGetElement('analysisOverview');
      if (!overview) return;
      
      const totalProducts = allProducts.length;
      const sources = [...new Set(allProducts.map(p => p.source))];
      const avgCost = totalProducts > 0 
        ? allProducts.reduce((sum, p) => sum + p.cost, 0) / totalProducts 
        : 0;
      const costs = allProducts.map(p => p.cost).filter(c => c > 0);
      const minCost = costs.length > 0 ? Math.min(...costs) : 0;
      const maxCost = costs.length > 0 ? Math.max(...costs) : 0;
      
      overview.innerHTML = `
        <div class="overview-card">
          <div class="label">ç¸½ç”¢å“æ•¸</div>
          <div class="number">${totalProducts}</div>
        </div>
        <div class="overview-card">
          <div class="label">ç”¢å“åº«æ•¸é‡</div>
          <div class="number">${sources.length}</div>
        </div>
        <div class="overview-card">
          <div class="label">å¹³å‡æˆæœ¬</div>
          <div class="number">$${avgCost.toFixed(0)}</div>
        </div>
        <div class="overview-card">
          <div class="label">æˆæœ¬ç¯„åœ</div>
          <div class="number" style="font-size: 1.5rem;">$${minCost}-${maxCost}</div>
        </div>
      `;
    }

    function updateSourceFilter() {
      const filter = safeGetElement('sourceFilter');
      if (!filter) return;
      
      const sources = [...new Set(allProducts.map(p => p.source))];
      filter.innerHTML = '<option value="">å…¨éƒ¨ä¾†æº</option>';
      sources.forEach(source => {
        filter.innerHTML += `<option value="${source}">${source}</option>`;
      });
    }

    function filterProducts() {
      const searchTerm = safeGetValue('searchProduct', '').toLowerCase();
      const sourceFilter = safeGetValue('sourceFilter', '');
      
      filteredProducts = allProducts.filter(product => {
        const matchSearch = !searchTerm || 
          product.prodId.toLowerCase().includes(searchTerm) ||
          product.name.toLowerCase().includes(searchTerm) ||
          product.spec.toLowerCase().includes(searchTerm) ||
          product.color.toLowerCase().includes(searchTerm);
          
        const matchSource = !sourceFilter || product.source === sourceFilter;
        
        return matchSearch && matchSource;
      });
      
      currentPage = 1;
      renderProductTable();
    }

    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      filteredProducts.sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        if (column === 'cost') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        }
        
        if (sortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });
      
      renderProductTable();
    }

    function renderProductTable() {
      const tbody = safeGetElement('productTableBody');
      if (!tbody) return;
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      tbody.innerHTML = '';
      
      pageProducts.forEach((product, index) => {
        const globalIndex = start + index;
        const row = tbody.insertRow();
        
        row.innerHTML = `
          <td><input type="checkbox" class="product-checkbox" data-index="${globalIndex}"></td>
          <td>${product.prodId || 'N/A'}</td>
          <td>${product.name || 'N/A'}</td>
          <td>${product.spec || '-'}</td>
          <td>${product.color || '-'}</td>
          <td>$${product.cost.toFixed(0)}</td>
          <td id="suggested-${globalIndex}">-</td>
          <td id="profit-${globalIndex}">-</td>
          <td>-</td>
          <td>${product.source}</td>
        `;
      });
      
      updatePagination();
    }

    function updatePagination() {
      const pagination = safeGetElement('pagination');
      if (!pagination) return;
      
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      
      pagination.innerHTML = `
        <button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>â—€ï¸ ä¸Šä¸€é </button>
        <span>ç¬¬ ${currentPage} / ${totalPages} é </span>
        <button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é  â–¶ï¸</button>
      `;
    }

    function changePage(delta) {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
      renderProductTable();
    }

    function toggleSelectAll() {
      const selectAll = safeGetElement('selectAll');
      const checkboxes = document.querySelectorAll('.product-checkbox');
      
      if (selectAll) {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
      }
    }

    function calculateBatchPricing() {
      const packaging = parseFloat(safeGetValue('batchPackaging', 10)) || 10;
      const labor = parseFloat(safeGetValue('batchLabor', 20)) || 20;
      const targetMargin = parseFloat(safeGetValue('batchMargin', 30)) || 30;
      
      const totalFeeRate = 5.5 + 2; // åŸºæœ¬æ‰‹çºŒè²» + é‡‘æµè²»
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      pageProducts.forEach((product, index) => {
        const globalIndex = start + index;
        const totalCost = product.cost + packaging + labor;
        const suggestedPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
        const netIncome = suggestedPrice * (1 - totalFeeRate / 100);
        const profit = netIncome - totalCost;
        
        const suggestedEl = document.getElementById(`suggested-${globalIndex}`);
        const profitEl = document.getElementById(`profit-${globalIndex}`);
        
        if (suggestedEl) {
          suggestedEl.textContent = `$${suggestedPrice.toFixed(0)}`;
          suggestedEl.style.fontWeight = 'bold';
          suggestedEl.style.color = '#667eea';
        }
        
        if (profitEl) {
          profitEl.textContent = `$${profit.toFixed(0)}`;
          profitEl.style.fontWeight = 'bold';
          profitEl.style.color = profit >= 0 ? '#28a745' : '#dc3545';
        }
      });
    }

    function exportSelectedProducts() {
      const checkboxes = document.querySelectorAll('.product-checkbox:checked');
      if (checkboxes.length === 0) {
        alert('âš ï¸ è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç”¢å“');
        return;
      }
      
      let csv = 'ç”¢å“ç·¨è™Ÿ,å•†å“åç¨±,è¦æ ¼,é¡è‰²,æˆæœ¬,ä¾†æº\n';
      
      checkboxes.forEach(cb => {
        const index = parseInt(cb.dataset.index);
        const product = filteredProducts[index];
        const row = [
          product.prodId,
          product.name,
          product.spec,
          product.color,
          product.cost,
          product.source
        ].map(val => `"${val}"`);
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ç”¢å“æ¸…å–®_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function updatePriceAnalysis() {
      const analysis = safeGetElement('priceAnalysis');
      if (!analysis) return;
      
      const costs = allProducts.map(p => p.cost).filter(c => c > 0);
      if (costs.length === 0) {
        analysis.innerHTML = '<p>æš«ç„¡æ•¸æ“š</p>';
        return;
      }
      
      const ranges = [
        { label: '$0-100', min: 0, max: 100 },
        { label: '$100-300', min: 100, max: 300 },
        { label: '$300-500', min: 300, max: 500 },
        { label: '$500-1000', min: 500, max: 1000 },
        { label: '$1000+', min: 1000, max: Infinity }
      ];
      
      let html = '<div style="display: grid; gap: 10px;">';
      
      ranges.forEach(range => {
        const count = costs.filter(c => c >= range.min && c < range.max).length;
        const percentage = ((count / costs.length) * 100).toFixed(1);
        
        html += `
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 100px; font-weight: 600;">${range.label}</div>
            <div style="flex: 1; background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
              <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                ${count > 0 ? `${count} (${percentage}%)` : ''}
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      analysis.innerHTML = html;
    }

    // ç«¶å“ç›£æ§
    function updateCompetitorPage() {
      updateCompetitorOverview();
      displayCompetitorTable();
      updateCompetitiveAnalysis();
      updatePriceAlerts();
    }

    function addCompetitor() {
      const myProductIndex = safeGetValue('myProductSelect', '');
      const compName = safeGetValue('compName', '');
      const compPrice = parseFloat(safeGetValue('compPrice', 0)) || 0;
      const compUrl = safeGetValue('compUrl', '');
      
      if (myProductIndex === '' || !compName || compPrice === 0) {
        alert('âš ï¸ è«‹å®Œæ•´å¡«å¯«è³‡æ–™');
        return;
      }
      
      const myProduct = allProducts[parseInt(myProductIndex)];
      if (!myProduct) return;
      
      // ç°¡å–®è¨ˆç®—æˆ‘æ–¹å”®åƒ¹ï¼ˆä½¿ç”¨åŸºæœ¬è²»ç‡ï¼‰
      const totalFeeRate = 7.5;
      const targetMargin = 30;
      const totalCost = myProduct.cost + 10 + 20;
      const myPrice = totalCost / (1 - (totalFeeRate + targetMargin) / 100);
      
      const priceDiff = myPrice - compPrice;
      const priceDiffPercent = ((priceDiff / compPrice) * 100).toFixed(1);
      
      competitorData.push({
        myProductCode: myProduct.prodId,
        myProductName: myProduct.name,
        myPrice: myPrice,
        compName: compName,
        compPrice: compPrice,
        compUrl: compUrl,
        priceDiff: priceDiff,
        priceDiffPercent: priceDiffPercent
      });
      
      // æ¸…ç©ºè¼¸å…¥
      const compNameInput = safeGetElement('compName');
      const compPriceInput = safeGetElement('compPrice');
      const compUrlInput = safeGetElement('compUrl');
      if (compNameInput) compNameInput.value = '';
      if (compPriceInput) compPriceInput.value = '';
      if (compUrlInput) compUrlInput.value = '';
      
      updateCompetitorPage();
    }

    function displayCompetitorTable() {
      const tbody = safeGetElement('competitorTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      const filter = safeGetValue('competitorFilter', 'all');
      
      let filteredData = competitorData;
      
      if (filter === 'advantage') {
        filteredData = competitorData.filter(c => c.priceDiff < 0);
      } else if (filter === 'disadvantage') {
        filteredData = competitorData.filter(c => c.priceDiff > 0);
      } else if (filter === 'warning') {
        filteredData = competitorData.filter(c => c.priceDiff > c.compPrice * 0.1);
      }
      
      filteredData.forEach((comp, index) => {
        const row = tbody.insertRow();
        
        const competitive = comp.priceDiff < 0 ? 'âœ… æœ‰å„ªå‹¢' : 
                          comp.priceDiff > comp.compPrice * 0.1 ? 'âš ï¸ éœ€é—œæ³¨' : 'âŒ è¼ƒè²´';
        
        const diffColor = comp.priceDiff < 0 ? '#28a745' : '#dc3545';
        
        row.innerHTML = `
          <td>${comp.myProductCode}</td>
          <td>${comp.myProductName}</td>
          <td>$${comp.myPrice.toFixed(0)}</td>
          <td>${comp.compName}</td>
          <td>$${comp.compPrice}</td>
          <td style="color: ${diffColor}; font-weight: bold;">$${comp.priceDiff.toFixed(0)}</td>
          <td style="color: ${diffColor}; font-weight: bold;">${comp.priceDiffPercent}%</td>
          <td>${competitive}</td>
          <td><button class="btn" onclick="deleteCompetitor(${index})" style="padding: 5px 10px; font-size: 0.85rem; background: #dc3545;">ğŸ—‘ï¸</button></td>
        `;
      });
    }

    function deleteCompetitor(index) {
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç«¶å“è³‡æ–™å—ï¼Ÿ')) {
        competitorData.splice(index, 1);
        updateCompetitorPage();
      }
    }

    function filterCompetitorTable() {
      displayCompetitorTable();
    }

    function updateCompetitorOverview() {
      const totalCount = competitorData.length;
      const advantageCount = competitorData.filter(c => c.priceDiff < 0).length;
      const disadvantageCount = competitorData.filter(c => c.priceDiff > 0).length;
      
      const avgDiff = totalCount > 0 
        ? competitorData.reduce((sum, c) => sum + parseFloat(c.priceDiffPercent), 0) / totalCount 
        : 0;
      
      const countEl = safeGetElement('competitorCount');
      const advantageEl = safeGetElement('advantageCount');
      const disadvantageEl = safeGetElement('disadvantageCount');
      const avgDiffEl = safeGetElement('avgDifference');
      
      if (countEl) countEl.textContent = totalCount;
      if (advantageEl) advantageEl.textContent = advantageCount;
      if (disadvantageEl) disadvantageEl.textContent = disadvantageCount;
      if (avgDiffEl) avgDiffEl.textContent = `${avgDiff.toFixed(1)}%`;
    }

    function updateCompetitiveAnalysis() {
      const analysis = safeGetElement('competitiveAnalysis');
      if (!analysis) return;
      
      if (competitorData.length === 0) {
        analysis.innerHTML = '<p style="color: #6c757d;">æš«ç„¡ç«¶å“æ•¸æ“š</p>';
        return;
      }
      
      const byProduct = {};
      competitorData.forEach(comp => {
        if (!byProduct[comp.myProductCode]) {
          byProduct[comp.myProductCode] = {
            name: comp.myProductName,
            myPrice: comp.myPrice,
            competitors: []
          };
        }
        byProduct[comp.myProductCode].competitors.push(comp);
      });
      
      let html = '';
      
      for (const code in byProduct) {
        const product = byProduct[code];
        const avgCompPrice = product.competitors.reduce((sum, c) => sum + c.compPrice, 0) / product.competitors.length;
        const priceDiff = product.myPrice - avgCompPrice;
        const diffColor = priceDiff < 0 ? '#28a745' : '#dc3545';
        
        html += `
          <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
            <h4 style="color: #2c3e50; margin-bottom: 10px;">${code} - ${product.name}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">æˆ‘æ–¹å”®åƒ¹</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: #667eea;">$${product.myPrice.toFixed(0)}</div>
              </div>
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">ç«¶å“å¹³å‡åƒ¹</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: #764ba2;">$${avgCompPrice.toFixed(0)}</div>
              </div>
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">åƒ¹æ ¼å·®ç•°</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: ${diffColor};">$${priceDiff.toFixed(0)}</div>
              </div>
              <div>
                <div style="color: #6c757d; font-size: 0.85rem;">ç«¶å“æ•¸é‡</div>
                <div style="font-size: 1.3rem; font-weight: bold; color: #6c757d;">${product.competitors.length}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      analysis.innerHTML = html;
    }

    function updatePriceAlerts() {
      const alerts = safeGetElement('priceAlerts');
      if (!alerts) return;
      
      const warnings = competitorData.filter(c => c.priceDiff > c.compPrice * 0.1);
      
      if (warnings.length === 0) {
        alerts.innerHTML = '<p style="color: #28a745;">âœ… ç›®å‰ç„¡éœ€è¦é—œæ³¨çš„ç”¢å“</p>';
        return;
      }
      
      let html = '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">';
      html += `<p style="color: #856404; font-weight: 600; margin-bottom: 10px;">âš ï¸ ç™¼ç¾ ${warnings.length} å€‹ç”¢å“åƒ¹æ ¼éœ€è¦é—œæ³¨ï¼š</p>`;
      html += '<ul style="margin: 0; padding-left: 20px; color: #856404;">';
      
      warnings.forEach(comp => {
        html += `
          <li style="margin: 5px 0;">
            <strong>${comp.myProductName}</strong>ï¼šæˆ‘æ–¹ $${comp.myPrice.toFixed(0)} vs ç«¶å“ $${comp.compPrice}ï¼ˆè²´äº† $${comp.priceDiff.toFixed(0)}ï¼Œ${comp.priceDiffPercent}%ï¼‰
          </li>
        `;
      });
      
      html += '</ul></div>';
      alerts.innerHTML = html;
    }

    function exportCompetitorData() {
      if (competitorData.length === 0) {
        alert('âš ï¸ æš«ç„¡ç«¶å“æ•¸æ“šå¯åŒ¯å‡º');
        return;
      }
      
      let csv = 'æˆ‘æ–¹ç”¢å“ç·¨è™Ÿ,æˆ‘æ–¹ç”¢å“åç¨±,æˆ‘æ–¹å”®åƒ¹,ç«¶å“åç¨±,ç«¶å“å”®åƒ¹,åƒ¹å·®,åƒ¹å·®%,ç«¶çˆ­åŠ›,ç«¶å“ç¶²å€\n';
      
      competitorData.forEach(comp => {
        const competitive = comp.priceDiff < 0 ? 'æœ‰å„ªå‹¢' : 
                          comp.priceDiff > comp.compPrice * 0.1 ? 'éœ€é—œæ³¨' : 'è¼ƒè²´';
        
        const row = [
          comp.myProductCode,
          comp.myProductName,
          comp.myPrice.toFixed(0),
          comp.compName,
          comp.compPrice,
          comp.priceDiff.toFixed(0),
          comp.priceDiffPercent + '%',
          competitive,
          comp.compUrl || ''
        ].map(val => `"${val}"`);
        
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `ç«¶å“æ¯”åƒ¹_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // é é¢åˆ‡æ›
    function showTab(tabName) {
      try {
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => content.classList.remove('active'));

        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach(btn => btn.classList.remove('active'));

        const targetContent = document.getElementById(tabName);
        if (targetContent) {
          targetContent.classList.add('active');
        }
        
        if (event && event.target) {
          event.target.classList.add('active');
        }

        // åˆ‡æ›åˆ°æ™ºèƒ½åˆ†ææ™‚è‡ªå‹•æ›´æ–°
        if (tabName === 'analysis' && allProducts.length > 0) {
          setTimeout(() => {
            updateAnalysisPage();
          }, 100);
        }
        
        // åˆ‡æ›åˆ°ç«¶å“ç›£æ§æ™‚è‡ªå‹•æ›´æ–°
        if (tabName === 'competitor' && allProducts.length > 0) {
          setTimeout(() => {
            updateCompetitorPage();
          }, 100);
        }
        
      } catch (error) {
        console.error('âŒ åˆ‡æ›é ç±¤æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    }

    // åˆå§‹åŒ–
    window.onload = function() {
      try {
        console.log('âœ… é é¢è¼‰å…¥å®Œæˆ');
        
        setTimeout(() => {
          updateFeeRateDisplay();
          console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
        }, 100);
        
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      }
    };
    </script>
  </div>
</body>
</html>
