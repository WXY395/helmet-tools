<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æ”¶æ”¯è¨˜å¸³ç³»çµ±</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
* { box-sizing: border-box; }
body { 
  font-family: "å¾®è»Ÿæ­£é»‘é«”", Arial, sans-serif;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  background: white;
  padding: 2em;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2em;
  padding-bottom: 1em;
  border-bottom: 3px solid #f5576c;
  flex-wrap: wrap;
  gap: 1em;
}
h2 { color: #2c3e50; margin: 0; }
.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5em;
  margin-bottom: 2em;
}
.summary-card {
  padding: 1.5em;
  border-radius: 15px;
  color: white;
  text-align: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.summary-card.income { background: linear-gradient(135deg, #56ab2f, #a8e063); }
.summary-card.expense { background: linear-gradient(135deg, #fa709a, #fee140); }
.summary-card.profit { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.summary-icon { font-size: 2em; margin-bottom: 0.3em; }
.summary-label { font-size: 0.9em; opacity: 0.9; }
.summary-value { font-size: 2em; font-weight: bold; margin: 0.3em 0; }
.period-selector {
  display: flex;
  gap: 0.5em;
  margin-bottom: 1.5em;
  flex-wrap: wrap;
}
.period-btn {
  padding: 8px 16px;
  border: 2px solid #f5576c;
  background: white;
  color: #f5576c;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: bold;
}
.period-btn.active {
  background: #f5576c;
  color: white;
}
.tabs {
  display: flex;
  gap: 1em;
  margin-bottom: 1.5em;
  border-bottom: 2px solid #f5576c;
}
.tab {
  padding: 10px 20px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  font-weight: bold;
  color: #7f8c8d;
}
.tab.active {
  color: #f5576c;
  border-bottom-color: #f5576c;
}
.record-card {
  background: white;
  border-radius: 12px;
  padding: 1.2em;
  margin-bottom: 0.8em;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-left: 4px solid #f5576c;
  transition: all 0.3s;
}
.record-card:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.record-card.income { border-left-color: #27ae60; }
.record-card.expense { border-left-color: #e74c3c; }
.record-info {
  flex: 1;
}
.record-category {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 15px;
  font-size: 0.85em;
  font-weight: bold;
  margin-right: 0.5em;
}
.category-income { background: #d4edda; color: #155724; }
.category-expense { background: #f8d7da; color: #721c24; }
.record-amount {
  font-size: 1.5em;
  font-weight: bold;
}
.record-amount.income { color: #27ae60; }
.record-amount.expense { color: #e74c3c; }
button {
  background: #f5576c;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
button.success { background: #27ae60; }
button.danger { background: #e74c3c; }
button.warning { background: #f39c12; }
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: white;
  padding: 2em;
  border-radius: 15px;
  max-width: 500px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
}
input, select, textarea {
  width: 100%;
  padding: 10px;
  margin: 0.5em 0;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 1em;
  font-family: inherit;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #f5576c;
}
.quick-add {
  position: fixed;
  bottom: 30px;
  right: 30px;
  display: flex;
  flex-direction: column;
  gap: 1em;
  z-index: 100;
}
.quick-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  color: white;
  font-size: 1.5em;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: all 0.3s;
}
.quick-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 30px rgba(0,0,0,0.4);
}
.quick-btn.income {
  background: linear-gradient(135deg, #56ab2f, #a8e063);
}
.quick-btn.expense {
  background: linear-gradient(135deg, #fa709a, #fee140);
}
.chart-section {
  background: white;
  padding: 1.5em;
  border-radius: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 2em;
}
.chart-container {
  position: relative;
  height: 300px;
}
@media (max-width: 768px) {
  .container { padding: 1em; }
  .summary-value { font-size: 1.6em; }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>ğŸ’° æ”¶æ”¯è¨˜å¸³ç³»çµ±</h2>
    <div style="display: flex; gap: 0.5em; flex-wrap: wrap;">
      <button onclick="exportRecords()" class="warning">ğŸ“Š åŒ¯å‡ºå ±è¡¨</button>
      <button onclick="showMonthlyReport()" class="success">ğŸ“‹ æœˆçµå ±è¡¨</button>
    </div>
  </div>

  <div class="period-selector">
    <button class="period-btn active" onclick="changePeriod('month')">æœ¬æœˆ</button>
    <button class="period-btn" onclick="changePeriod('quarter')">æœ¬å­£</button>
    <button class="period-btn" onclick="changePeriod('year')">æœ¬å¹´</button>
    <button class="period-btn" onclick="changePeriod('all')">å…¨éƒ¨</button>
  </div>

  <div class="summary-cards">
    <div class="summary-card income">
      <div class="summary-icon">ğŸ’µ</div>
      <div class="summary-label">ç¸½æ”¶å…¥</div>
      <div class="summary-value" id="totalIncome">$0</div>
    </div>
    <div class="summary-card expense">
      <div class="summary-icon">ğŸ’¸</div>
      <div class="summary-label">ç¸½æ”¯å‡º</div>
      <div class="summary-value" id="totalExpense">$0</div>
    </div>
    <div class="summary-card profit">
      <div class="summary-icon">ğŸ’</div>
      <div class="summary-label">æ·¨åˆ©æ½¤</div>
      <div class="summary-value" id="netProfit">$0</div>
    </div>
  </div>

  <div class="chart-section">
    <h3 style="margin-top: 0; color: #2c3e50;">ğŸ“ˆ æ”¶æ”¯è¶¨å‹¢</h3>
    <div class="chart-container">
      <canvas id="trendChart"></canvas>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="changeTab('all')">å…¨éƒ¨è¨˜éŒ„</div>
    <div class="tab" onclick="changeTab('income')">æ”¶å…¥</div>
    <div class="tab" onclick="changeTab('expense')">æ”¯å‡º</div>
  </div>

  <div id="recordsList">
    <div style="text-align: center; color: #7f8c8d; padding: 3em;">
      <div style="font-size: 3em; margin-bottom: 0.5em;">ğŸ“</div>
      ç›®å‰æ²’æœ‰è¨˜å¸³è¨˜éŒ„<br>é»æ“Šå³ä¸‹è§’æŒ‰éˆ•é–‹å§‹è¨˜å¸³
    </div>
  </div>
</div>

<div class="quick-add">
  <div class="quick-btn income" onclick="showAddRecord('income')" title="æ–°å¢æ”¶å…¥">ğŸ’µ</div>
  <div class="quick-btn expense" onclick="showAddRecord('expense')" title="æ–°å¢æ”¯å‡º">ğŸ’¸</div>
</div>

<!-- æ–°å¢è¨˜éŒ„ Modal -->
<div id="recordModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle">æ–°å¢æ”¶å…¥</h3>
    <input type="hidden" id="recordId">
    <input type="hidden" id="recordType">
    
    <label>æ—¥æœŸï¼š</label>
    <input type="date" id="recordDate">
    
    <label>é¡åˆ¥ï¼š</label>
    <select id="recordCategory">
      <!-- å‹•æ…‹ç”Ÿæˆ -->
    </select>
    
    <label>é‡‘é¡ï¼ˆå…ƒï¼‰ï¼š</label>
    <input type="number" id="recordAmount" value="0" min="0" step="1">
    
    <label>èªªæ˜ï¼š</label>
    <textarea id="recordNote" rows="3" placeholder="é¸å¡«"></textarea>
    
    <div style="margin-top: 1.5em; display: flex; gap: 1em;">
      <button onclick="saveRecord()" class="success">ğŸ’¾ ä¿å­˜</button>
      <button onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
let records = [];
let currentPeriod = 'month';
let currentTab = 'all';
let trendChart;

const incomeCategories = ['å•†å“éŠ·å”®', 'é…ä»¶éŠ·å”®', 'çµ„åˆå„ªæƒ ', 'é‹è²»æ”¶å…¥', 'å…¶ä»–æ”¶å…¥'];
const expenseCategories = ['é€²è²¨æˆæœ¬', 'é‹è²»æ”¯å‡º', 'åŒ…æè²»ç”¨', 'å»£å‘Šè²»ç”¨', 'äººäº‹è²»ç”¨', 'ç§Ÿé‡‘æ°´é›»', 'å¹³å°æ‰‹çºŒè²»', 'å…¶ä»–æ”¯å‡º'];

window.onload = function() {
  loadRecords();
  document.getElementById('recordDate').valueAsDate = new Date();
  initChart();
  updateSummary();
  renderRecords();
};

function loadRecords() {
  try {
    if (window.accountingData) {
      records = window.accountingData;
    }
  } catch(e) {
    console.log('è¼‰å…¥è¨˜å¸³è³‡æ–™å¤±æ•—');
  }
}

function saveRecords() {
  try {
    window.accountingData = records;
  } catch(e) {
    console.log('ä¿å­˜è¨˜å¸³è³‡æ–™å¤±æ•—');
  }
}

function showAddRecord(type) {
  document.getElementById('modalTitle').textContent = type === 'income' ? 'æ–°å¢æ”¶å…¥' : 'æ–°å¢æ”¯å‡º';
  document.getElementById('recordId').value = '';
  document.getElementById('recordType').value = type;
  document.getElementById('recordDate').valueAsDate = new Date();
  document.getElementById('recordAmount').value = '0';
  document.getElementById('recordNote').value = '';
  
  let categorySelect = document.getElementById('recordCategory');
  categorySelect.innerHTML = '';
  let categories = type === 'income' ? incomeCategories : expenseCategories;
  categories.forEach(cat => {
    let option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    categorySelect.appendChild(option);
  });
  
  document.getElementById('recordModal').style.display = 'flex';
}

function saveRecord() {
  let id = document.getElementById('recordId').value;
  
  let record = {
    id: id || Date.now().toString(),
    type: document.getElementById('recordType').value,
    date: document.getElementById('recordDate').value,
    category: document.getElementById('recordCategory').value,
    amount: parseFloat(document.getElementById('recordAmount').value) || 0,
    note: document.getElementById('recordNote').value.trim(),
    createdAt: id ? records.find(r => r.id === id).createdAt : new Date().toISOString()
  };
  
  if (!record.date) {
    alert('è«‹é¸æ“‡æ—¥æœŸï¼');
    return;
  }
  
  if (record.amount <= 0) {
    alert('é‡‘é¡å¿…é ˆå¤§æ–¼ 0ï¼');
    return;
  }
  
  if (id) {
    let index = records.findIndex(r => r.id === id);
    records[index] = record;
  } else {
    records.unshift(record);
  }
  
  saveRecords();
  updateSummary();
  renderRecords();
  closeModal();
  alert('âœ… è¨˜éŒ„å·²ä¿å­˜ï¼');
}

function deleteRecord(id) {
  let record = records.find(r => r.id === id);
  if (!record) return;
  
  let typeText = record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
  if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†${typeText}è¨˜éŒ„å—ï¼Ÿ\n\n${record.category}ï¼š$${record.amount}\n${record.date}\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
    records = records.filter(r => r.id !== id);
    saveRecords();
    updateSummary();
    renderRecords();
    alert('âœ… è¨˜éŒ„å·²åˆªé™¤');
  }
}

function changePeriod(period) {
  currentPeriod = period;
  document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateSummary();
  renderRecords();
}

function changeTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderRecords();
}

function getFilteredRecords() {
  let now = new Date();
  let startDate;
  
  switch(currentPeriod) {
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
    case 'quarter':
      let quarter = Math.floor(now.getMonth() / 3);
      startDate = new Date(now.getFullYear(), quarter * 3, 1);
      break;
    case 'year':
      startDate = new Date(now.getFullYear(), 0, 1);
      break;
    default:
      return records;
  }
  
  return records.filter(record => new Date(record.date) >= startDate);
}

function updateSummary() {
  let filtered = getFilteredRecords();
  
  let income = filtered.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
  let expense = filtered.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
  let profit = income - expense;
  
  document.getElementById('totalIncome').textContent = '$' + income.toFixed(0);
  document.getElementById('totalExpense').textContent = '$' + expense.toFixed(0);
  document.getElementById('netProfit').textContent = '$' + profit.toFixed(0);
  document.getElementById('netProfit').style.color = profit >= 0 ? 'white' : '#e74c3c';
  
  updateChart(filtered);
}

function initChart() {
  let ctx = document.getElementById('trendChart').getContext('2d');
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'æ”¶å…¥',
        data: [],
        borderColor: '#27ae60',
        backgroundColor: 'rgba(39, 174, 96, 0.1)',
        tension: 0.4
      }, {
        label: 'æ”¯å‡º',
        data: [],
        borderColor: '#e74c3c',
        backgroundColor: 'rgba(231, 76, 60, 0.1)',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' }
      }
    }
  });
}

function updateChart(filtered) {
  let dateMap = {};
  
  filtered.forEach(record => {
    if (!dateMap[record.date]) {
      dateMap[record.date] = { income: 0, expense: 0 };
    }
    if (record.type === 'income') {
      dateMap[record.date].income += record.amount;
    } else {
      dateMap[record.date].expense += record.amount;
    }
  });
  
  let dates = Object.keys(dateMap).sort();
  let incomeData = dates.map(date => dateMap[date].income);
  let expenseData = dates.map(date => dateMap[date].expense);
  
  trendChart.data.labels = dates;
  trendChart.data.datasets[0].data = incomeData;
  trendChart.data.datasets[1].data = expenseData;
  trendChart.update();
}

function renderRecords() {
  let filtered = getFilteredRecords();
  
  if (currentTab === 'income') {
    filtered = filtered.filter(r => r.type === 'income');
  } else if (currentTab === 'expense') {
    filtered = filtered.filter(r => r.type === 'expense');
  }
  
  filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  let html = '';
  
  if (filtered.length === 0) {
    html = `
      <div style="text-align: center; color: #7f8c8d; padding: 3em;">
        <div style="font-size: 3em; margin-bottom: 0.5em;">ğŸ“</div>
        ç›®å‰æ²’æœ‰è¨˜éŒ„
      </div>
    `;
  } else {
    filtered.forEach(record => {
      let typeClass = record.type === 'income' ? 'income' : 'expense';
      let categoryClass = record.type === 'income' ? 'category-income' : 'category-expense';
      let sign = record.type === 'income' ? '+' : '-';
      
      html += `
        <div class="record-card ${typeClass}">
          <div class="record-info">
            <span class="record-category ${categoryClass}">${record.category}</span>
            <div style="margin-top: 0.5em; color: #7f8c8d; font-size: 0.9em;">
              ${record.date}
              ${record.note ? `<br>${record.note}` : ''}
            </div>
          </div>
          <div style="text-align: right;">
            <div class="record-amount ${typeClass}">${sign}$${record.amount.toFixed(0)}</div>
            <button onclick="deleteRecord('${record.id}')" class="danger" style="padding: 5px 10px; font-size: 0.8em; margin-top: 0.5em;">ğŸ—‘ï¸</button>
          </div>
        </div>
      `;
    });
  }
  
  document.getElementById('recordsList').innerHTML = html;
}

function exportRecords() {
  if (records.length === 0) {
    alert('ç›®å‰æ²’æœ‰è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
    return;
  }
  
  let filtered = getFilteredRecords();
  let csv = 'æ—¥æœŸ,é¡å‹,é¡åˆ¥,é‡‘é¡,èªªæ˜\n';
  
  filtered.forEach(record => {
    let typeText = record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º';
    csv += `${record.date},${typeText},${record.category},${record.amount},"${record.note}"\n`;
  });
  
  let blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  let link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'æ”¶æ”¯æ˜ç´°_' + currentPeriod + '_' + new Date().toLocaleDateString('zh-TW') + '.csv';
  link.click();
  
  alert('âœ… æ”¶æ”¯æ˜ç´°å·²åŒ¯å‡ºï¼');
}

function showMonthlyReport() {
  let filtered = getFilteredRecords();
  
  if (filtered.length === 0) {
    alert('ç›®å‰æ²’æœ‰è¨˜éŒ„ï¼');
    return;
  }
  
  let income = filtered.filter(r => r.type === 'income').reduce((sum, r) => sum + r.amount, 0);
  let expense = filtered.filter(r => r.type === 'expense').reduce((sum, r) => sum + r.amount, 0);
  let profit = income - expense;
  let profitRate = income > 0 ? (profit / income * 100) : 0;
  
  // åˆ†é¡çµ±è¨ˆ
  let incomeByCategory = {};
  let expenseByCategory = {};
  
  filtered.forEach(record => {
    if (record.type === 'income') {
      if (!incomeByCategory[record.category]) incomeByCategory[record.category] = 0;
      incomeByCategory[record.category] += record.amount;
    } else {
      if (!expenseByCategory[record.category]) expenseByCategory[record.category] = 0;
      expenseByCategory[record.category] += record.amount;
    }
  });
  
  let message = `ğŸ“‹ ${currentPeriod === 'month' ? 'æœ¬æœˆ' : (currentPeriod === 'quarter' ? 'æœ¬å­£' : currentPeriod === 'year' ? 'æœ¬å¹´' : 'å…¨æœŸ')}æç›Šå ±è¡¨\n\n`;
  message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  message += `ğŸ’µ ç¸½æ”¶å…¥ï¼š${income.toFixed(0)}\n`;
  
  for (let cat in incomeByCategory) {
    message += `   ${cat}ï¼š${incomeByCategory[cat].toFixed(0)}\n`;
  }
  
  message += `\nğŸ’¸ ç¸½æ”¯å‡ºï¼š${expense.toFixed(0)}\n`;
  
  for (let cat in expenseByCategory) {
    message += `   ${cat}ï¼š${expenseByCategory[cat].toFixed(0)}\n`;
  }
  
  message += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  message += `ğŸ’ æ·¨åˆ©æ½¤ï¼š${profit.toFixed(0)}\n`;
  message += `ğŸ“Š åˆ©æ½¤ç‡ï¼š${profitRate.toFixed(1)}%\n`;
  message += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  if (profit < 0) {
    message += `âš ï¸ æœ¬æœŸè™§æ ${Math.abs(profit).toFixed(0)}ï¼Œè«‹æ³¨æ„æˆæœ¬æ§åˆ¶ï¼`;
  } else if (profitRate < 10) {
    message += `ğŸ’¡ åˆ©æ½¤ç‡åä½ï¼Œå»ºè­°æª¢è¦–æˆæœ¬çµæ§‹æˆ–èª¿æ•´å”®åƒ¹ã€‚`;
  } else if (profitRate < 20) {
    message += `âœ… ç¶“ç‡Ÿç‹€æ³è‰¯å¥½ï¼ŒæŒçºŒä¿æŒï¼`;
  } else {
    message += `ğŸ‰ å„ªç§€ï¼åˆ©æ½¤ç‡è¡¨ç¾äº®çœ¼ï¼`;
  }
  
  alert(message);
}

function closeModal() {
  document.getElementById('recordModal').style.display = 'none';
}

document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal();
    }
  });
});
</script>
</body>
</html>